<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>../backend/fetch_pingdom.py</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl str">&quot;&quot;&quot; This script fetches statistics from Pingdom. Requires </span>
<span class="hl str">pingdom_settings.py with correct PINGDOM_USER, PINGDOM_PASSWORD, </span>
<span class="hl str">PINGDOM_APPKEY and UPTIME_CLASSES &quot;&quot;&quot;</span>

<span class="hl kwa">import</span> pingdom
<span class="hl kwa">import</span> json
<span class="hl kwa">import</span> datetime
<span class="hl kwa">import</span> time
<span class="hl kwa">import</span> os
<span class="hl kwa">import</span> logging
<span class="hl kwa">import</span> redis
<span class="hl kwa">import</span> hashlib
<span class="hl kwa">from</span> dateutil <span class="hl kwa">import</span> rrule

<span class="hl kwa">try</span><span class="hl opt">:</span>
    <span class="hl slc"># cPickle is much faster than pickle</span>
    <span class="hl kwa">import</span> cPickle <span class="hl kwa">as</span> pickle
<span class="hl kwa">except</span> <span class="hl kwc">ImportError</span><span class="hl opt">:</span>
    <span class="hl kwa">import</span> pickle

<span class="hl kwa">import</span> pingdom_settings

<span class="hl kwa">class</span> Pingdomrun<span class="hl opt">:</span>
    <span class="hl str">&quot;&quot;&quot; Fetch data from pingdom, calculate basic metrics like number of </span>
<span class="hl str">        outages, uptime percentages and save data as json &quot;&quot;&quot;</span>

    <span class="hl kwa">def</span> <span class="hl kwd">__init__</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        self<span class="hl opt">.</span>uptime_classes <span class="hl opt">=</span> pingdom_settings<span class="hl opt">.</span>UPTIME_CLASSES
        self<span class="hl opt">.</span>connection <span class="hl opt">=</span> pingdom<span class="hl opt">.</span><span class="hl kwd">PingdomConnection</span><span class="hl opt">(</span>
                          pingdom_settings<span class="hl opt">.</span>PINGDOM_USERNAME<span class="hl opt">,</span> 
                          pingdom_settings<span class="hl opt">.</span>PINGDOM_PASSWORD<span class="hl opt">,</span> 
                          pingdom_settings<span class="hl opt">.</span>PINGDOM_APPKEY<span class="hl opt">)</span>
        self<span class="hl opt">.</span>cache_directory <span class="hl opt">=</span> <span class="hl str">&quot;cache/&quot;</span>
        self<span class="hl opt">.</span>data <span class="hl opt">=</span> <span class="hl kwa">None</span>
        self<span class="hl opt">.</span>cdata <span class="hl opt">=</span> <span class="hl kwa">None</span>
        self<span class="hl opt">.</span>redis <span class="hl opt">=</span> redis<span class="hl opt">.</span><span class="hl kwd">Redis</span><span class="hl opt">(</span>unix_socket_path<span class="hl opt">=</span><span class="hl str">&quot;/home/redis/redis.sock&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>redis<span class="hl opt">.</span><span class="hl kwd">pipeline</span><span class="hl opt">(</span>transaction<span class="hl opt">=</span><span class="hl kwa">False</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span>stats <span class="hl opt">= {}</span>

    <span class="hl kwa">def</span> <span class="hl kwd">incrstat</span><span class="hl opt">(</span>self<span class="hl opt">,</span> what<span class="hl opt">):</span>
        <span class="hl kwa">if not</span> self<span class="hl opt">.</span>stats<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>what<span class="hl opt">):</span>
            self<span class="hl opt">.</span>stats<span class="hl opt">[</span>what<span class="hl opt">] =</span> <span class="hl num">0</span>
        self<span class="hl opt">.</span>stats<span class="hl opt">[</span>what<span class="hl opt">] +=</span> <span class="hl num">1</span>

    <span class="hl kwa">def</span> <span class="hl kwd">executestat</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl kwa">for</span> k<span class="hl opt">,</span> v <span class="hl kwa">in</span> self<span class="hl opt">.</span>stats<span class="hl opt">.</span><span class="hl kwd">items</span><span class="hl opt">():</span>
            self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">incr</span><span class="hl opt">(</span>k<span class="hl opt">,</span> v<span class="hl opt">)</span>
        self<span class="hl opt">.</span>stats <span class="hl opt">= {}</span>
        self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">execute</span><span class="hl opt">()</span>

    <span class="hl kwa">def</span> <span class="hl kwd">get_cache</span><span class="hl opt">(</span>self<span class="hl opt">,</span> what<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get pickled data from cache &quot;&quot;&quot;</span>
        what <span class="hl opt">=</span> <span class="hl str">&quot;pingdomcache:%s&quot;</span> <span class="hl opt">%</span> what
        self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">execute</span><span class="hl opt">()</span>
        value <span class="hl opt">=</span> self<span class="hl opt">.</span>redis<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>what<span class="hl opt">)</span>
        <span class="hl kwa">if not</span> value<span class="hl opt">:</span>
            self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:pingdom:miss&quot;</span><span class="hl opt">)</span>
            self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:miss&quot;</span><span class="hl opt">)</span>
            logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Cache miss: %s&quot;</span><span class="hl opt">,</span> what<span class="hl opt">)</span>
            <span class="hl kwa">return False</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:pingdom:hit&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:hit&quot;</span><span class="hl opt">)</span>
        logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Cache hit: %s&quot;</span><span class="hl opt">,</span> what<span class="hl opt">)</span>
        <span class="hl kwa">return</span> pickle<span class="hl opt">.</span><span class="hl kwd">loads</span><span class="hl opt">(</span>value<span class="hl opt">)</span>

    <span class="hl kwa">def</span> <span class="hl kwd">set_cache</span><span class="hl opt">(</span>self<span class="hl opt">,</span> what<span class="hl opt">,</span> data<span class="hl opt">,</span> expire <span class="hl opt">=</span> <span class="hl num">3600</span> <span class="hl opt">*</span> <span class="hl num">24</span> <span class="hl opt">*</span> <span class="hl num">30</span> <span class="hl opt">*</span> <span class="hl num">24</span><span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Set (pickled) data to cache &quot;&quot;&quot;</span>
        what <span class="hl opt">=</span> <span class="hl str">&quot;pingdomcache:%s&quot;</span> <span class="hl opt">%</span> what
        <span class="hl kwa">if</span> expire<span class="hl opt">:</span>
            status <span class="hl opt">=</span> self<span class="hl opt">.</span>redis<span class="hl opt">.</span><span class="hl kwd">setex</span><span class="hl opt">(</span>what<span class="hl opt">,</span> pickle<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">(</span>data<span class="hl opt">),</span> expire<span class="hl opt">)</span>
        <span class="hl kwa">else</span><span class="hl opt">:</span>
            status <span class="hl opt">=</span> self<span class="hl opt">.</span>redis<span class="hl opt">.</span><span class="hl kwb">set</span><span class="hl opt">(</span>what<span class="hl opt">,</span> pickle<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">(</span>data<span class="hl opt">))</span>
        <span class="hl kwa">if</span> status<span class="hl opt">:</span>
            logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Cache set: %s&quot;</span><span class="hl opt">,</span> what<span class="hl opt">)</span>
            self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:pingdom:set&quot;</span><span class="hl opt">)</span>
            self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:set&quot;</span><span class="hl opt">)</span>
        <span class="hl kwa">else</span><span class="hl opt">:</span>
            logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Cache set for %s failed&quot;</span><span class="hl opt">,</span> what<span class="hl opt">)</span>
            self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:pingdom:setfailed&quot;</span><span class="hl opt">)</span>
            self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:cache:setfailed&quot;</span><span class="hl opt">)</span>

    <span class="hl kwa">def</span> <span class="hl kwd">get_performance</span><span class="hl opt">(</span>self<span class="hl opt">,</span> checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> resolution<span class="hl opt">):</span>
        keyname <span class="hl opt">=</span> <span class="hl str">&quot;performance-%s-%s-%s-%s&quot;</span> <span class="hl opt">% (</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> resolution<span class="hl opt">)</span>
        cached <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">)</span>
        <span class="hl kwa">if</span> cached <span class="hl kwa">is not False</span><span class="hl opt">:</span>
            <span class="hl kwa">return</span> cached
        data <span class="hl opt">=</span> self<span class="hl opt">.</span>connection<span class="hl opt">.</span><span class="hl kwd">get_performance</span><span class="hl opt">(</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">=</span>timefrom<span class="hl opt">,</span> timeto<span class="hl opt">=</span>timeto<span class="hl opt">,</span> resolution<span class="hl opt">=</span>resolution<span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:pingdom:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">set_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">,</span> data<span class="hl opt">)</span>
        <span class="hl kwa">return</span> data

    <span class="hl kwa">def</span> <span class="hl kwd">get_checks</span><span class="hl opt">(</span>self<span class="hl opt">, **</span>kwargs<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get list of checks and check details (status, last check </span>
<span class="hl str">          time, name etc.) &quot;&quot;&quot;</span>

        cached <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_cache</span><span class="hl opt">(</span><span class="hl str">&quot;checks&quot;</span><span class="hl opt">)</span>
        <span class="hl kwa">if</span> cached <span class="hl kwa">is not False</span><span class="hl opt">:</span>
            logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Cache hit for checks&quot;</span><span class="hl opt">)</span>
            <span class="hl kwa">return</span> cached
        checks <span class="hl opt">=</span> self<span class="hl opt">.</span>connection<span class="hl opt">.</span><span class="hl kwd">get_all_checks</span><span class="hl opt">()</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:pingdom:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">set_cache</span><span class="hl opt">(</span><span class="hl str">&quot;checks&quot;</span><span class="hl opt">,</span> checks<span class="hl opt">,</span> <span class="hl num">55</span><span class="hl opt">)</span>
        <span class="hl kwa">return</span> checks

    <span class="hl kwa">def</span> <span class="hl kwd">get_averages</span><span class="hl opt">(</span>self<span class="hl opt">,</span> checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> expire<span class="hl opt">=</span><span class="hl kwa">None</span><span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get averages for single check and single timeframe &quot;&quot;&quot;</span>
        keyname <span class="hl opt">=</span> <span class="hl str">&quot;averages-%s-%s-%s&quot;</span> <span class="hl opt">% (</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">)</span>
        cached <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">)</span>
        <span class="hl kwa">if</span> cached <span class="hl kwa">is not False</span><span class="hl opt">:</span>
            <span class="hl kwa">return</span> cached
        averages <span class="hl opt">=</span> self<span class="hl opt">.</span>connection<span class="hl opt">.</span><span class="hl kwd">get_check_averages</span><span class="hl opt">(</span>checkid<span class="hl opt">,</span> 
                               timefrom<span class="hl opt">=</span>timefrom<span class="hl opt">,</span> timeto<span class="hl opt">=</span>timeto<span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:pingdom:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">set_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">,</span> averages<span class="hl opt">,</span> expire<span class="hl opt">)</span>
        logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Averages fetched for range %s-%s, check %s&quot;</span><span class="hl opt">,</span>
                             timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> checkid<span class="hl opt">)</span>
        <span class="hl kwa">return</span> averages

    <span class="hl kwa">def</span> <span class="hl kwd">get_outages</span><span class="hl opt">(</span>self<span class="hl opt">,</span> checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> expire<span class="hl opt">=</span><span class="hl kwa">None</span><span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get outages for single check &quot;&quot;&quot;</span>
        keyname <span class="hl opt">=</span> <span class="hl str">&quot;outages-%s-%s-%s&quot;</span> <span class="hl opt">% (</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">)</span>
        cached <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">)</span>
        <span class="hl kwa">if</span> cached <span class="hl kwa">is not False</span><span class="hl opt">:</span>
            <span class="hl kwa">return</span> cached
        outages <span class="hl opt">=</span> self<span class="hl opt">.</span>connection<span class="hl opt">.</span><span class="hl kwd">get_outages</span><span class="hl opt">(</span>checkid<span class="hl opt">,</span> 
                              timefrom<span class="hl opt">=</span>timefrom<span class="hl opt">,</span> timeto<span class="hl opt">=</span>timeto<span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:pingdom:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">incrstat</span><span class="hl opt">(</span><span class="hl str">&quot;stats:api:request&quot;</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">set_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">,</span> outages<span class="hl opt">,</span> expire<span class="hl opt">)</span>
        logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Outages fetched for range %s-%s, check %s&quot;</span><span class="hl opt">,</span>
                               timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> checkid<span class="hl opt">)</span>
        <span class="hl kwa">return</span> outages

    <span class="hl kwb">&#64;staticmethod</span>
    <span class="hl kwa">def</span> <span class="hl kwd">gen_daterange</span><span class="hl opt">():</span>
        <span class="hl str">&quot;&quot;&quot; Returns list of tuples containing start of day (unix </span>
<span class="hl str">            timestamp), end of day (unix timestamp) and human readable </span>
<span class="hl str">            name for day &quot;&quot;&quot;</span>
        begin <span class="hl opt">=</span> datetime<span class="hl opt">.</span>date<span class="hl opt">.</span><span class="hl kwd">today</span><span class="hl opt">() -</span> datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>days<span class="hl opt">=</span><span class="hl num">6</span><span class="hl opt">)</span>
        days_timeranges <span class="hl opt">= []</span>
        <span class="hl kwa">for</span> dt <span class="hl kwa">in</span> rrule<span class="hl opt">.</span><span class="hl kwd">rrule</span><span class="hl opt">(</span>rrule<span class="hl opt">.</span>DAILY<span class="hl opt">,</span> dtstart<span class="hl opt">=</span>begin<span class="hl opt">,</span> until<span class="hl opt">=</span>datetime<span class="hl opt">.</span>date<span class="hl opt">.</span><span class="hl kwd">today</span><span class="hl opt">()):</span>
            range_start <span class="hl opt">=</span> <span class="hl kwb">int</span><span class="hl opt">(</span>time<span class="hl opt">.</span><span class="hl kwd">mktime</span><span class="hl opt">(</span>dt<span class="hl opt">.</span><span class="hl kwd">timetuple</span><span class="hl opt">()))</span>
            range_end <span class="hl opt">=</span> <span class="hl kwb">int</span><span class="hl opt">(</span>time<span class="hl opt">.</span><span class="hl kwd">mktime</span><span class="hl opt">((</span>dt <span class="hl opt">+</span> datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>days<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">) -</span> datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>seconds<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">)).</span><span class="hl kwd">timetuple</span><span class="hl opt">()))</span>
            days_timeranges<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">((</span>range_start<span class="hl opt">,</span> range_end<span class="hl opt">,</span> dt<span class="hl opt">.</span><span class="hl kwd">strftime</span><span class="hl opt">(</span><span class="hl str">&quot;%d.%m.&quot;</span><span class="hl opt">)))</span>
        <span class="hl kwa">return</span> days_timeranges

    <span class="hl kwa">def</span> <span class="hl kwd">populate_check_keywords</span><span class="hl opt">(</span>self<span class="hl opt">,</span> check<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Populate cdata with basic check keywords - some might be </span>
<span class="hl str">            missing, for example if check never failed &quot;&quot;&quot;</span>
        check_keywords <span class="hl opt">= [</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;name&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;type&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;resolution&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;lasterrortime&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;lastresponsetime&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;lasttesttime&quot;</span><span class="hl opt">]</span>
        <span class="hl kwa">for</span> keyword <span class="hl kwa">in</span> check_keywords<span class="hl opt">:</span>
            <span class="hl kwa">try</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span>keyword<span class="hl opt">] =</span> <span class="hl kwb">getattr</span><span class="hl opt">(</span>check<span class="hl opt">,</span> keyword<span class="hl opt">)</span>
            <span class="hl kwa">except</span> <span class="hl kwc">AttributeError</span><span class="hl opt">:</span>
                <span class="hl kwa">pass</span>

    <span class="hl kwa">def</span> <span class="hl kwd">get_check_averages</span><span class="hl opt">(</span>self<span class="hl opt">,</span> check<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> counter<span class="hl opt">,</span> temporary_cache<span class="hl opt">=</span><span class="hl kwa">False</span><span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get averages and calculate necessary data &quot;&quot;&quot;</span>
        <span class="hl kwa">if</span> temporary_cache<span class="hl opt">:</span>
            averages <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_averages</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> <span class="hl num">1000</span><span class="hl opt">)</span>
        <span class="hl kwa">else</span><span class="hl opt">:</span>
            averages <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_averages</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> <span class="hl num">3600</span> <span class="hl opt">*</span> <span class="hl num">24</span> <span class="hl opt">*</span> <span class="hl num">450</span><span class="hl opt">)</span>
        avgresponse <span class="hl opt">=</span> <span class="hl num">0</span>
        avgcounter <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">for</span> item <span class="hl kwa">in</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;responsetime&quot;</span><span class="hl opt">][</span><span class="hl str">'avgresponse'</span><span class="hl opt">]:</span>
            avgcounter <span class="hl opt">+=</span> <span class="hl num">1</span>
            avgresponse <span class="hl opt">+=</span> item<span class="hl opt">[</span><span class="hl str">'avgresponse'</span><span class="hl opt">]</span>
        <span class="hl kwa">if</span> avgcounter <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">:</span>
            avgresponse <span class="hl opt">=</span> <span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl kwb">float</span><span class="hl opt">(</span>avgresponse<span class="hl opt">) /</span> avgcounter<span class="hl opt">)</span>
        self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;avgms&quot;</span><span class="hl opt">] += [</span>avgresponse<span class="hl opt">]</span>
        self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
        self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>
        self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;up_per_day&quot;</span><span class="hl opt">][</span>counter<span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>
        self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;down_per_day&quot;</span><span class="hl opt">][</span>counter<span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
        <span class="hl kwa">if</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
            uptime <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">else</span><span class="hl opt">:</span>
            uptime <span class="hl opt">=</span> <span class="hl kwb">min</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">,</span> <span class="hl kwb">round</span><span class="hl opt">((</span><span class="hl kwb">float</span><span class="hl opt">(</span>averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]),</span> <span class="hl num">6</span><span class="hl opt">))</span>
        self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;dates&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">({</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">:</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">],</span> <span class="hl str">&quot;up&quot;</span><span class="hl opt">:</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">],</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> uptime<span class="hl opt">})</span>

        self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;downtime_total&quot;</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
        self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;uptime_total&quot;</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>
        <span class="hl kwa">for</span> classkey <span class="hl kwa">in</span> self<span class="hl opt">.</span>uptime_classes<span class="hl opt">:</span>
            <span class="hl kwa">if</span> check<span class="hl opt">.</span><span class="hl kwb">id</span> <span class="hl kwa">in</span> self<span class="hl opt">.</span>uptime_classes<span class="hl opt">[</span>classkey<span class="hl opt">][</span><span class="hl str">'id'</span><span class="hl opt">]:</span>
                self<span class="hl opt">.</span>uptime_classes<span class="hl opt">[</span>classkey<span class="hl opt">][</span><span class="hl str">'down'</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
                self<span class="hl opt">.</span>uptime_classes<span class="hl opt">[</span>classkey<span class="hl opt">][</span><span class="hl str">'up'</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>

    <span class="hl kwa">def</span> <span class="hl kwd">get_check_outages</span><span class="hl opt">(</span>self<span class="hl opt">,</span> check<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> today_night<span class="hl opt">,</span> counter<span class="hl opt">,</span> temporary_cache<span class="hl opt">=</span><span class="hl kwa">False</span><span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get outages information for specific check &quot;&quot;&quot;</span>
        <span class="hl kwa">if</span> temporary_cache<span class="hl opt">:</span>
            outages <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_outages</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> <span class="hl num">1000</span><span class="hl opt">)</span>
        <span class="hl kwa">else</span><span class="hl opt">:</span>
            outages <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_outages</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> <span class="hl num">3600</span> <span class="hl opt">*</span> <span class="hl num">24</span> <span class="hl opt">*</span> <span class="hl num">400</span><span class="hl opt">)</span>
        <span class="hl kwa">for</span> item <span class="hl kwa">in</span> outages<span class="hl opt">[</span><span class="hl str">'states'</span><span class="hl opt">]:</span>
            <span class="hl kwa">if</span> item<span class="hl opt">[</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">] ==</span> <span class="hl str">&quot;down&quot;</span><span class="hl opt">:</span>
                <span class="hl kwa">if</span> item<span class="hl opt">[</span><span class="hl str">&quot;timefrom&quot;</span><span class="hl opt">] &gt;</span> today_night<span class="hl opt">:</span>
                    self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;outages_today&quot;</span><span class="hl opt">] +=</span> <span class="hl num">1</span>
                <span class="hl kwa">if</span> item<span class="hl opt">[</span><span class="hl str">&quot;timefrom&quot;</span><span class="hl opt">] &gt;</span> today_night<span class="hl opt">-</span><span class="hl num">7</span><span class="hl opt">*</span><span class="hl num">86400</span><span class="hl opt">:</span>
                    self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;outages_week&quot;</span><span class="hl opt">] +=</span> <span class="hl num">1</span>
                self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;outages_per_day&quot;</span><span class="hl opt">][</span>counter<span class="hl opt">] +=</span> <span class="hl num">1</span>



    <span class="hl kwa">def</span> <span class="hl kwd">calculate_uptime_data</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Calculate final statistics: uptime class values and per day </span>
<span class="hl str">            uptimes&quot;&quot;&quot;</span>
        <span class="hl kwa">for</span> item <span class="hl kwa">in</span> self<span class="hl opt">.</span>uptime_classes<span class="hl opt">:</span>
            <span class="hl kwa">if</span> self<span class="hl opt">.</span>uptime_classes<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">][</span>item<span class="hl opt">] =</span> <span class="hl num">0</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">][</span>item<span class="hl opt">] =</span> <span class="hl kwb">str</span><span class="hl opt">(</span><span class="hl kwb">min</span><span class="hl opt">(</span><span class="hl num">100</span><span class="hl opt">,</span> <span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl num">100</span> <span class="hl opt">* (</span><span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>uptime_classes<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>uptime_classes<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>uptime_classes<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]),</span> <span class="hl num">3</span><span class="hl opt">)))+</span><span class="hl str">&quot;%&quot;</span>
        <span class="hl kwa">for</span> item <span class="hl kwa">in</span> self<span class="hl opt">.</span>cdata<span class="hl opt">:</span>
            <span class="hl kwa">if</span> self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;u&quot;</span><span class="hl opt">] =</span> <span class="hl num">0</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;u&quot;</span><span class="hl opt">] =</span> <span class="hl kwb">min</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">,</span> <span class="hl kwb">round</span><span class="hl opt">((</span><span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]),</span> <span class="hl num">6</span><span class="hl opt">))</span>
            <span class="hl kwa">del</span> self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]</span>
            <span class="hl kwa">del</span> self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">]</span>

        <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;up_per_day&quot;</span><span class="hl opt">])):</span>
            <span class="hl kwa">if</span> self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;up_per_day&quot;</span><span class="hl opt">][</span>i<span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                t_uptime <span class="hl opt">=</span> <span class="hl num">0</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                t_uptime <span class="hl opt">=</span> <span class="hl kwb">str</span><span class="hl opt">(</span><span class="hl kwb">min</span><span class="hl opt">(</span><span class="hl num">100</span><span class="hl opt">,</span> <span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl num">100</span><span class="hl opt">*(</span><span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;up_per_day&quot;</span><span class="hl opt">][</span>i<span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;down_per_day&quot;</span><span class="hl opt">][</span>i<span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;up_per_day&quot;</span><span class="hl opt">][</span>i<span class="hl opt">]),</span> <span class="hl num">3</span><span class="hl opt">)))</span>
            self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;uptime_per_day&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">(</span>t_uptime<span class="hl opt">)</span>
        self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;overall&quot;</span><span class="hl opt">] =</span> <span class="hl kwb">str</span><span class="hl opt">(</span><span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl num">100</span><span class="hl opt">*(</span><span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;uptime_total&quot;</span><span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;downtime_total&quot;</span><span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;uptime_total&quot;</span><span class="hl opt">]),</span> <span class="hl num">3</span><span class="hl opt">))+</span><span class="hl str">&quot;%&quot;</span>


    <span class="hl kwa">def</span> <span class="hl kwd">run</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get all data. Run save() to save it &quot;&quot;&quot;</span>
        checks <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_checks</span><span class="hl opt">(</span>nocache<span class="hl opt">=</span><span class="hl kwa">True</span><span class="hl opt">)</span>

        today_night <span class="hl opt">=</span> time<span class="hl opt">.</span><span class="hl kwd">mktime</span><span class="hl opt">(</span>datetime<span class="hl opt">.</span>date<span class="hl opt">.</span><span class="hl kwd">today</span><span class="hl opt">().</span><span class="hl kwd">timetuple</span><span class="hl opt">())</span>
        days_timeranges <span class="hl opt">=</span> Pingdomrun<span class="hl opt">.</span><span class="hl kwd">gen_daterange</span><span class="hl opt">()</span>

        self<span class="hl opt">.</span>cdata <span class="hl opt">= {}</span>
        self<span class="hl opt">.</span>data <span class="hl opt">= {</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;overall&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                                  <span class="hl str">&quot;outages_today&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                                  <span class="hl str">&quot;outages_week&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                                  <span class="hl str">&quot;networks&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                                  <span class="hl str">&quot;virtualization_platforms&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                                  <span class="hl str">&quot;websites&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span>
                     <span class="hl str">&quot;day_titles&quot;</span><span class="hl opt">:</span> days_timeranges<span class="hl opt">,</span>
                     <span class="hl str">&quot;uptime_per_day&quot;</span><span class="hl opt">: [],</span>
                     <span class="hl str">&quot;outages_per_day&quot;</span><span class="hl opt">: [</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">],</span>
                     <span class="hl str">&quot;services_up&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                     <span class="hl str">&quot;services_down&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                     <span class="hl str">&quot;services_unknown&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                     <span class="hl str">&quot;up_per_day&quot;</span><span class="hl opt">: [</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">],</span>
                     <span class="hl str">&quot;down_per_day&quot;</span><span class="hl opt">: [</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">],</span>
                     <span class="hl str">&quot;uptime_total&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span>
                     <span class="hl str">&quot;downtime_total&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">}</span>

        today <span class="hl opt">=</span> datetime<span class="hl opt">.</span>date<span class="hl opt">.</span><span class="hl kwd">today</span><span class="hl opt">()</span>
        monday <span class="hl opt">=</span> today <span class="hl opt">-</span> datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>days<span class="hl opt">=</span>today<span class="hl opt">.</span><span class="hl kwd">weekday</span><span class="hl opt">())</span>
        begin <span class="hl opt">=</span> monday <span class="hl opt">-</span> datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>days<span class="hl opt">=</span><span class="hl num">112</span><span class="hl opt">)</span>
       
        weeks <span class="hl opt">= []</span>
        <span class="hl kwa">for</span> dt <span class="hl kwa">in</span> rrule<span class="hl opt">.</span><span class="hl kwd">rrule</span><span class="hl opt">(</span>rrule<span class="hl opt">.</span>WEEKLY<span class="hl opt">,</span> dtstart<span class="hl opt">=</span>begin<span class="hl opt">,</span> until<span class="hl opt">=</span>monday<span class="hl opt">-</span>datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>days<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">)):</span>
            week_sunday <span class="hl opt">=</span> dt <span class="hl opt">+</span> datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>days<span class="hl opt">=</span><span class="hl num">7</span><span class="hl opt">) -</span> datetime<span class="hl opt">.</span><span class="hl kwd">timedelta</span><span class="hl opt">(</span>seconds<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">)</span>
            weeks<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">((</span>dt<span class="hl opt">,</span> week_sunday<span class="hl opt">))</span>

        <span class="hl kwa">for</span> check <span class="hl kwa">in</span> checks<span class="hl opt">:</span>
            
            self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">] = {</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;up&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span>
                                    <span class="hl str">&quot;dates&quot;</span><span class="hl opt">: [],</span>
                                    <span class="hl str">&quot;avgms&quot;</span><span class="hl opt">: []}</span>

            self<span class="hl opt">.</span><span class="hl kwd">populate_check_keywords</span><span class="hl opt">(</span>check<span class="hl opt">)</span>




            <span class="hl kwa">if</span> check<span class="hl opt">.</span>status <span class="hl opt">==</span> <span class="hl str">&quot;up&quot;</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;services_up&quot;</span><span class="hl opt">] +=</span> <span class="hl num">1</span>
            <span class="hl kwa">elif</span> check<span class="hl opt">.</span>status <span class="hl opt">==</span> <span class="hl str">&quot;down&quot;</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;services_down&quot;</span><span class="hl opt">] +=</span> <span class="hl num">1</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;services_unknown&quot;</span><span class="hl opt">] +=</span> <span class="hl num">1</span>

            counter <span class="hl opt">=</span> <span class="hl num">0</span>
            last <span class="hl opt">=</span> <span class="hl kwa">False</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span>timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> _<span class="hl opt">)</span> <span class="hl kwa">in</span> days_timeranges<span class="hl opt">:</span>
                <span class="hl kwa">if</span> counter <span class="hl opt">+</span> <span class="hl num">1</span> <span class="hl opt">==</span> <span class="hl kwb">len</span><span class="hl opt">(</span>days_timeranges<span class="hl opt">):</span>
                    last <span class="hl opt">=</span> <span class="hl kwa">True</span>
                self<span class="hl opt">.</span><span class="hl kwd">get_check_averages</span><span class="hl opt">(</span>check<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> counter<span class="hl opt">,</span> last<span class="hl opt">)</span>
                self<span class="hl opt">.</span><span class="hl kwd">get_check_outages</span><span class="hl opt">(</span>check<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> today_night<span class="hl opt">,</span> counter<span class="hl opt">,</span> last<span class="hl opt">)</span>
                counter <span class="hl opt">+=</span> <span class="hl num">1</span>

            checkdetails <span class="hl opt">= {</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">:</span> self<span class="hl opt">.</span>cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">]};</span>
            checkdetails<span class="hl opt">[</span><span class="hl str">&quot;per_day&quot;</span><span class="hl opt">] = []</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span>week_start<span class="hl opt">,</span> week_end<span class="hl opt">)</span> <span class="hl kwa">in</span> weeks<span class="hl opt">:</span>
                details <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_performance</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> time<span class="hl opt">.</span><span class="hl kwd">mktime</span><span class="hl opt">(</span>week_start<span class="hl opt">.</span><span class="hl kwd">timetuple</span><span class="hl opt">()),</span> time<span class="hl opt">.</span><span class="hl kwd">mktime</span><span class="hl opt">(</span>week_end<span class="hl opt">.</span><span class="hl kwd">timetuple</span><span class="hl opt">()),</span> <span class="hl str">&quot;day&quot;</span><span class="hl opt">).</span>content<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">]</span>
                <span class="hl kwa">for</span> item <span class="hl kwa">in</span> details<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">&quot;days&quot;</span><span class="hl opt">):</span>
                    checkdetails<span class="hl opt">[</span><span class="hl str">&quot;per_day&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">(</span>item<span class="hl opt">)</span>
            self<span class="hl opt">.</span><span class="hl kwd">save_check</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> checkdetails<span class="hl opt">)</span>

        self<span class="hl opt">.</span><span class="hl kwd">calculate_uptime_data</span><span class="hl opt">()</span>

        self<span class="hl opt">.</span>data<span class="hl opt">[</span><span class="hl str">&quot;timestamp&quot;</span><span class="hl opt">] = {</span><span class="hl str">&quot;unix&quot;</span><span class="hl opt">:</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">(),</span> 
             <span class="hl str">&quot;human&quot;</span><span class="hl opt">:</span> datetime<span class="hl opt">.</span>datetime<span class="hl opt">.</span><span class="hl kwd">now</span><span class="hl opt">().</span><span class="hl kwd">strftime</span><span class="hl opt">(</span><span class="hl str">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="hl opt">)}</span>
        self<span class="hl opt">.</span><span class="hl kwd">executestat</span><span class="hl opt">()</span>

    <span class="hl kwa">def</span> <span class="hl kwd">_save</span><span class="hl opt">(</span>self<span class="hl opt">,</span> filename<span class="hl opt">,</span> new_data<span class="hl opt">,</span> expire<span class="hl opt">=</span><span class="hl kwa">None</span><span class="hl opt">):</span>
        old_data <span class="hl opt">=</span> self<span class="hl opt">.</span>redis<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>filename<span class="hl opt">+</span><span class="hl str">&quot;-hash&quot;</span><span class="hl opt">)</span>
        <span class="hl kwb">hash</span> <span class="hl opt">=</span> hashlib<span class="hl opt">.</span><span class="hl kwd">sha1</span><span class="hl opt">(</span>new_data<span class="hl opt">).</span><span class="hl kwd">hexdigest</span><span class="hl opt">()</span>
        <span class="hl kwa">if</span> old_data <span class="hl opt">!=</span> <span class="hl kwb">hash</span><span class="hl opt">:</span>
            self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">publish</span><span class="hl opt">(</span><span class="hl str">&quot;pubsub:&quot;</span><span class="hl opt">+</span>filename<span class="hl opt">,</span> json<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">({</span><span class="hl str">&quot;hash&quot;</span><span class="hl opt">:</span> <span class="hl kwb">hash</span><span class="hl opt">,</span> <span class="hl str">&quot;mtime&quot;</span><span class="hl opt">:</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">()}))</span>
            <span class="hl kwa">if</span> expire<span class="hl opt">:</span>
                self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">setex</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> new_data<span class="hl opt">,</span> expire<span class="hl opt">)</span>
                self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">setex</span><span class="hl opt">(</span>filename<span class="hl opt">+</span><span class="hl str">&quot;-mtime&quot;</span><span class="hl opt">,</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">(),</span> expire<span class="hl opt">)</span>
                self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">setex</span><span class="hl opt">(</span>filename<span class="hl opt">+</span><span class="hl str">&quot;-hash&quot;</span><span class="hl opt">,</span> <span class="hl kwb">hash</span><span class="hl opt">,</span> expire<span class="hl opt">)</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwb">set</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> new_data<span class="hl opt">)</span>
                self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwb">set</span><span class="hl opt">(</span>filename<span class="hl opt">+</span><span class="hl str">&quot;-mtime&quot;</span><span class="hl opt">,</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">())</span>
                self<span class="hl opt">.</span>pipe <span class="hl opt">=</span> self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwb">set</span><span class="hl opt">(</span>filename<span class="hl opt">+</span><span class="hl str">&quot;-hash&quot;</span><span class="hl opt">,</span> <span class="hl kwb">hash</span><span class="hl opt">)</span>
        self<span class="hl opt">.</span>pipe<span class="hl opt">.</span><span class="hl kwd">execute</span><span class="hl opt">()</span>


    <span class="hl kwa">def</span> <span class="hl kwd">save_check</span><span class="hl opt">(</span>self<span class="hl opt">,</span> checkid<span class="hl opt">,</span> checkdetails<span class="hl opt">):</span>
        new_data <span class="hl opt">=</span> json<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">(</span>checkdetails<span class="hl opt">)</span>
        filename <span class="hl opt">=</span> <span class="hl str">&quot;data:per-check-%s.json&quot;</span> <span class="hl opt">%</span> checkid
        self<span class="hl opt">.</span><span class="hl kwd">_save</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> new_data<span class="hl opt">,</span> <span class="hl num">3600</span><span class="hl opt">*</span><span class="hl num">24</span><span class="hl opt">*</span><span class="hl num">30</span><span class="hl opt">)</span>

    <span class="hl kwa">def</span> <span class="hl kwd">save</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Save data to services.json &quot;&quot;&quot;</span>
        new_data <span class="hl opt">=</span> json<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">({</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">:</span> self<span class="hl opt">.</span>data<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">&quot;autofill&quot;</span><span class="hl opt">, {}),</span> <span class="hl str">&quot;overall&quot;</span><span class="hl opt">:</span> self<span class="hl opt">.</span>data<span class="hl opt">,</span> <span class="hl str">&quot;per_service&quot;</span><span class="hl opt">:</span> self<span class="hl opt">.</span>cdata<span class="hl opt">})</span>
        filename <span class="hl opt">=</span> <span class="hl str">&quot;data:services.json&quot;</span>
        self<span class="hl opt">.</span><span class="hl kwd">_save</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> new_data<span class="hl opt">,</span> <span class="hl num">3600</span><span class="hl opt">*</span><span class="hl num">24</span><span class="hl opt">*</span><span class="hl num">30</span><span class="hl opt">)</span>


<span class="hl kwa">def</span> <span class="hl kwd">main</span><span class="hl opt">():</span>
    <span class="hl str">&quot;&quot;&quot; Run pingdom statistics &quot;&quot;&quot;</span>
    pingdomstats <span class="hl opt">=</span> <span class="hl kwd">Pingdomrun</span><span class="hl opt">()</span>
    pingdomstats<span class="hl opt">.</span><span class="hl kwd">run</span><span class="hl opt">()</span>
    pingdomstats<span class="hl opt">.</span><span class="hl kwd">save</span><span class="hl opt">()</span>

<span class="hl kwa">if</span> __name__ <span class="hl opt">==</span> <span class="hl str">'__main__'</span><span class="hl opt">:</span>
    <span class="hl kwd">main</span><span class="hl opt">()</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.5, http://www.andre-simon.de/-->
