<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>backend/fetch_pingdom.py</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl kwa">import</span> pingdom
<span class="hl kwa">import</span> json
<span class="hl kwa">import</span> datetime
<span class="hl kwa">import</span> time
<span class="hl kwa">import</span> os
<span class="hl kwa">import</span> sys
<span class="hl kwa">import</span> pickle

<span class="hl kwa">from</span> pingdom_settings <span class="hl kwa">import</span> <span class="hl opt">*</span>

<span class="hl kwa">class</span> Pingdomrun<span class="hl opt">:</span>

    <span class="hl kwa">def</span> <span class="hl kwd">__init__</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        self<span class="hl opt">.</span>connection <span class="hl opt">=</span> pingdom<span class="hl opt">.</span><span class="hl kwd">PingdomConnection</span><span class="hl opt">(</span>PINGDOM_USERNAME<span class="hl opt">,</span> PINGDOM_PASSWORD<span class="hl opt">,</span> PINGDOM_APPKEY<span class="hl opt">)</span>

    <span class="hl kwa">def</span> <span class="hl kwd">get_cache</span><span class="hl opt">(</span>self<span class="hl opt">,</span> what<span class="hl opt">):</span>
        <span class="hl kwa">if</span> os<span class="hl opt">.</span>path<span class="hl opt">.</span><span class="hl kwd">exists</span><span class="hl opt">(</span><span class="hl str">&quot;cache/%s&quot;</span> <span class="hl opt">%</span> what<span class="hl opt">):</span>
            <span class="hl kwa">return</span> pickle<span class="hl opt">.</span><span class="hl kwd">loads</span><span class="hl opt">(</span><span class="hl kwb">open</span><span class="hl opt">(</span><span class="hl str">&quot;cache/%s&quot;</span> <span class="hl opt">%</span> what<span class="hl opt">).</span><span class="hl kwd">read</span><span class="hl opt">())</span>
        <span class="hl kwa">return False</span>

    <span class="hl kwa">def</span> <span class="hl kwd">set_cache</span><span class="hl opt">(</span>self<span class="hl opt">,</span> what<span class="hl opt">,</span> data<span class="hl opt">):</span>
        <span class="hl kwb">open</span><span class="hl opt">(</span><span class="hl str">&quot;cache/%s&quot;</span> <span class="hl opt">%</span> what<span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">).</span><span class="hl kwd">write</span><span class="hl opt">(</span>pickle<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">(</span>data<span class="hl opt">))</span>

    <span class="hl kwa">def</span> <span class="hl kwd">get_checks</span><span class="hl opt">(</span>self<span class="hl opt">, **</span>kwargs<span class="hl opt">):</span>
        <span class="hl kwa">if not</span> kwargs<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span><span class="hl str">&quot;nocache&quot;</span><span class="hl opt">,</span> <span class="hl kwa">False</span><span class="hl opt">):</span>
            cached <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_cache</span><span class="hl opt">(</span><span class="hl str">&quot;checks&quot;</span><span class="hl opt">)</span>
            <span class="hl kwa">if</span> cached <span class="hl kwa">is not False</span><span class="hl opt">:</span>
                <span class="hl kwa">return</span> cached
        checks <span class="hl opt">=</span> self<span class="hl opt">.</span>connection<span class="hl opt">.</span><span class="hl kwd">get_all_checks</span><span class="hl opt">()</span>
        self<span class="hl opt">.</span><span class="hl kwd">set_cache</span><span class="hl opt">(</span><span class="hl str">&quot;checks&quot;</span><span class="hl opt">,</span> checks<span class="hl opt">)</span>
        <span class="hl kwa">return</span> checks

    <span class="hl kwa">def</span> <span class="hl kwd">get_averages</span><span class="hl opt">(</span>self<span class="hl opt">,</span> checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">):</span>
        keyname <span class="hl opt">=</span> <span class="hl str">&quot;averages-%s-%s-%s&quot;</span> <span class="hl opt">% (</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">)</span>
        cached <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">)</span>
        <span class="hl kwa">if</span> cached <span class="hl kwa">is not False</span><span class="hl opt">:</span>
            <span class="hl kwa">return</span> cached
        averages <span class="hl opt">=</span> self<span class="hl opt">.</span>connection<span class="hl opt">.</span><span class="hl kwd">get_check_averages</span><span class="hl opt">(</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">=</span>timefrom<span class="hl opt">,</span> timeto<span class="hl opt">=</span>timeto<span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">set_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">,</span> averages<span class="hl opt">)</span>
        <span class="hl kwa">return</span> averages

    <span class="hl kwa">def</span> <span class="hl kwd">get_outages</span><span class="hl opt">(</span>self<span class="hl opt">,</span> checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">):</span>
        keyname <span class="hl opt">=</span> <span class="hl str">&quot;outages-%s-%s-%s&quot;</span> <span class="hl opt">% (</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">)</span>
        cached <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">)</span>
        <span class="hl kwa">if</span> cached <span class="hl kwa">is not False</span><span class="hl opt">:</span>
            <span class="hl kwa">return</span> cached
        outages <span class="hl opt">=</span> self<span class="hl opt">.</span>connection<span class="hl opt">.</span><span class="hl kwd">get_outages</span><span class="hl opt">(</span>checkid<span class="hl opt">,</span> timefrom<span class="hl opt">=</span>timefrom<span class="hl opt">,</span> timeto<span class="hl opt">=</span>timeto<span class="hl opt">)</span>
        self<span class="hl opt">.</span><span class="hl kwd">set_cache</span><span class="hl opt">(</span>keyname<span class="hl opt">,</span> outages<span class="hl opt">)</span>
        <span class="hl kwa">return</span> outages

    <span class="hl kwa">def</span> <span class="hl kwd">run</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        checks <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_checks</span><span class="hl opt">(</span>nocache<span class="hl opt">=</span><span class="hl kwa">True</span><span class="hl opt">)</span>

        today_night <span class="hl opt">=</span> time<span class="hl opt">.</span><span class="hl kwd">mktime</span><span class="hl opt">(</span>datetime<span class="hl opt">.</span>date<span class="hl opt">.</span><span class="hl kwd">today</span><span class="hl opt">().</span><span class="hl kwd">timetuple</span><span class="hl opt">())</span>
        today_last <span class="hl opt">=</span> <span class="hl kwb">int</span><span class="hl opt">(</span>time<span class="hl opt">.</span><span class="hl kwd">mktime</span><span class="hl opt">(</span>datetime<span class="hl opt">.</span>datetime<span class="hl opt">.</span><span class="hl kwd">now</span><span class="hl opt">().</span><span class="hl kwd">timetuple</span><span class="hl opt">()) /</span> <span class="hl num">1000</span> <span class="hl opt">) *</span> <span class="hl num">1000</span>
        days_timeranges <span class="hl opt">= []</span>

        <span class="hl kwa">for</span> a <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">5</span><span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">):</span>
            new_end_time <span class="hl opt">=</span> today_night <span class="hl opt">-</span> <span class="hl num">86400</span> <span class="hl opt">*</span> a
            new_start_time <span class="hl opt">=</span> today_night <span class="hl opt">-</span> <span class="hl num">86400</span> <span class="hl opt">* (</span>a <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">)</span>
            days_timeranges<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">((</span>new_start_time<span class="hl opt">,</span> new_end_time<span class="hl opt">,</span> datetime<span class="hl opt">.</span>datetime<span class="hl opt">.</span><span class="hl kwd">fromtimestamp</span><span class="hl opt">(</span>new_start_time<span class="hl opt">).</span><span class="hl kwd">strftime</span><span class="hl opt">(</span><span class="hl str">&quot;%d.%m.&quot;</span><span class="hl opt">)))</span>
	days_timeranges<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">((</span>today_night<span class="hl opt">,</span> today_last<span class="hl opt">,</span> datetime<span class="hl opt">.</span>datetime<span class="hl opt">.</span><span class="hl kwd">fromtimestamp</span><span class="hl opt">(</span>today_last<span class="hl opt">).</span><span class="hl kwd">strftime</span><span class="hl opt">(</span><span class="hl str">&quot;%d.%m. %H:%M&quot;</span><span class="hl opt">)))</span>

        data <span class="hl opt">= {</span><span class="hl str">&quot;overall&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;outages_today&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;outages_week&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;networks&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;virtualization_platforms&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;websites&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;day_titles&quot;</span><span class="hl opt">:</span> days_timeranges<span class="hl opt">,</span> <span class="hl str">&quot;uptime_per_day&quot;</span><span class="hl opt">: [],</span> <span class="hl str">&quot;outages_per_day&quot;</span><span class="hl opt">: []}</span>
        cdata <span class="hl opt">= {}</span>

        up_per_day <span class="hl opt">= [</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">]</span>
        down_per_day <span class="hl opt">= [</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">]</span>
        outages_per_day <span class="hl opt">= [</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">,</span><span class="hl num">0</span><span class="hl opt">]</span>
        uptime_total <span class="hl opt">=</span> <span class="hl num">0</span>
        downtime_total <span class="hl opt">=</span> <span class="hl num">0</span>
        CHECK_KEYWORDS<span class="hl opt">=[</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;name&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;type&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;resolution&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;lasterrortime&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;lastresponsetime&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;lasttesttime&quot;</span><span class="hl opt">]</span>
        <span class="hl kwa">for</span> check <span class="hl kwa">in</span> checks<span class="hl opt">:</span>
            cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">] = {</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;up&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span> <span class="hl str">&quot;dates&quot;</span><span class="hl opt">: [],</span> <span class="hl str">&quot;avgms&quot;</span><span class="hl opt">: []}</span>
            <span class="hl kwa">for</span> keyword <span class="hl kwa">in</span> CHECK_KEYWORDS<span class="hl opt">:</span>
                <span class="hl kwa">try</span><span class="hl opt">:</span>
                    cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span>keyword<span class="hl opt">] =</span> <span class="hl kwb">getattr</span><span class="hl opt">(</span>check<span class="hl opt">,</span> keyword<span class="hl opt">)</span>
                <span class="hl kwa">except</span> <span class="hl kwc">AttributeError</span><span class="hl opt">:</span>
                    <span class="hl kwa">pass</span>

            counter <span class="hl opt">=</span> <span class="hl num">0</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span>timefrom<span class="hl opt">,</span> timeto<span class="hl opt">,</span> datename<span class="hl opt">)</span> <span class="hl kwa">in</span> days_timeranges<span class="hl opt">:</span>
                averages <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_averages</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">)</span>
                avgresponse <span class="hl opt">=</span> <span class="hl num">0</span>
                c <span class="hl opt">=</span> <span class="hl num">0</span>
                <span class="hl kwa">for</span> item <span class="hl kwa">in</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;responsetime&quot;</span><span class="hl opt">][</span><span class="hl str">'avgresponse'</span><span class="hl opt">]:</span>
                    c <span class="hl opt">+=</span> <span class="hl num">1</span>
                    avgresponse <span class="hl opt">+=</span> item<span class="hl opt">[</span><span class="hl str">'avgresponse'</span><span class="hl opt">]</span>
                <span class="hl kwa">if</span> c <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">:</span>
                     avgresponse <span class="hl opt">=</span> <span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl kwb">float</span><span class="hl opt">(</span>avgresponse<span class="hl opt">) /</span> c<span class="hl opt">)</span>
                cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;avgms&quot;</span><span class="hl opt">] += [</span>avgresponse<span class="hl opt">]</span>
                cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
                cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>
                up_per_day<span class="hl opt">[</span>counter<span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>
                down_per_day<span class="hl opt">[</span>counter<span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
                <span class="hl kwa">if</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                    uptime <span class="hl opt">=</span> <span class="hl num">0</span>
                <span class="hl kwa">else</span><span class="hl opt">:</span>
                    uptime <span class="hl opt">=</span> <span class="hl kwb">round</span><span class="hl opt">((</span><span class="hl kwb">float</span><span class="hl opt">(</span>averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]),</span> <span class="hl num">6</span><span class="hl opt">)</span>
                cdata<span class="hl opt">[</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">][</span><span class="hl str">&quot;dates&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">({</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">:</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">],</span> <span class="hl str">&quot;up&quot;</span><span class="hl opt">:</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">],</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> uptime<span class="hl opt">})</span>

                downtime_total <span class="hl opt">+=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
                uptime_total <span class="hl opt">+=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>
                <span class="hl kwa">for</span> classkey <span class="hl kwa">in</span> UPTIME_CLASSES<span class="hl opt">:</span>
                    <span class="hl kwa">if</span> check<span class="hl opt">.</span><span class="hl kwb">id</span> <span class="hl kwa">in</span> UPTIME_CLASSES<span class="hl opt">[</span>classkey<span class="hl opt">][</span><span class="hl str">'id'</span><span class="hl opt">]:</span>
                        UPTIME_CLASSES<span class="hl opt">[</span>classkey<span class="hl opt">][</span><span class="hl str">'down'</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totaldown&quot;</span><span class="hl opt">]</span>
                        UPTIME_CLASSES<span class="hl opt">[</span>classkey<span class="hl opt">][</span><span class="hl str">'up'</span><span class="hl opt">] +=</span> averages<span class="hl opt">[</span><span class="hl str">&quot;summary&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;totalup&quot;</span><span class="hl opt">]</span>


                outages <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">get_outages</span><span class="hl opt">(</span>check<span class="hl opt">.</span><span class="hl kwb">id</span><span class="hl opt">,</span> timefrom<span class="hl opt">,</span> timeto<span class="hl opt">)</span>
                <span class="hl kwa">for</span> item <span class="hl kwa">in</span> outages<span class="hl opt">[</span><span class="hl str">'states'</span><span class="hl opt">]:</span>
                    <span class="hl kwa">if</span> item<span class="hl opt">[</span><span class="hl str">&quot;status&quot;</span><span class="hl opt">] ==</span> <span class="hl str">&quot;down&quot;</span><span class="hl opt">:</span>
                        <span class="hl kwa">if</span> item<span class="hl opt">[</span><span class="hl str">&quot;timefrom&quot;</span><span class="hl opt">] &gt;</span> today_night<span class="hl opt">:</span>
                             data<span class="hl opt">[</span><span class="hl str">&quot;outages_today&quot;</span><span class="hl opt">] +=</span> <span class="hl num">1</span>
                        <span class="hl kwa">if</span> item<span class="hl opt">[</span><span class="hl str">&quot;timefrom&quot;</span><span class="hl opt">] &gt;</span> today_night<span class="hl opt">-</span><span class="hl num">7</span><span class="hl opt">*</span><span class="hl num">86400</span><span class="hl opt">:</span>
                             data<span class="hl opt">[</span><span class="hl str">&quot;outages_week&quot;</span><span class="hl opt">] +=</span> <span class="hl num">1</span>
                        outages_per_day<span class="hl opt">[</span>counter<span class="hl opt">] +=</span> <span class="hl num">1</span>
                counter <span class="hl opt">+=</span> <span class="hl num">1</span>


        <span class="hl kwa">for</span> item <span class="hl kwa">in</span> UPTIME_CLASSES<span class="hl opt">:</span>
            <span class="hl kwa">if</span> UPTIME_CLASSES<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                data<span class="hl opt">[</span>item<span class="hl opt">] =</span> <span class="hl num">0</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                data<span class="hl opt">[</span>item<span class="hl opt">] =</span> <span class="hl kwb">str</span><span class="hl opt">(</span><span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl num">100</span> <span class="hl opt">* (</span><span class="hl kwb">float</span><span class="hl opt">(</span>UPTIME_CLASSES<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>UPTIME_CLASSES<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>UPTIME_CLASSES<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]),</span> <span class="hl num">3</span><span class="hl opt">))+</span><span class="hl str">&quot;%&quot;</span>
        <span class="hl kwa">for</span> item <span class="hl kwa">in</span> cdata<span class="hl opt">:</span>
            <span class="hl kwa">if</span> cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;u&quot;</span><span class="hl opt">] =</span> <span class="hl num">0</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;u&quot;</span><span class="hl opt">] =</span> <span class="hl kwb">round</span><span class="hl opt">((</span><span class="hl kwb">float</span><span class="hl opt">(</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]),</span> <span class="hl num">6</span><span class="hl opt">)</span>
            <span class="hl kwa">del</span> cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;up&quot;</span><span class="hl opt">]</span>
            <span class="hl kwa">del</span> cdata<span class="hl opt">[</span>item<span class="hl opt">][</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">][</span><span class="hl str">&quot;down&quot;</span><span class="hl opt">]</span>

        <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>up_per_day<span class="hl opt">)):</span>
            <span class="hl kwa">if</span> up_per_day<span class="hl opt">[</span>i<span class="hl opt">] ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                t_uptime <span class="hl opt">=</span> <span class="hl num">0</span>
            <span class="hl kwa">else</span><span class="hl opt">:</span>
                t_uptime <span class="hl opt">=</span> <span class="hl kwb">str</span><span class="hl opt">(</span><span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl num">100</span><span class="hl opt">*(</span><span class="hl kwb">float</span><span class="hl opt">(</span>up_per_day<span class="hl opt">[</span>i<span class="hl opt">]) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>down_per_day<span class="hl opt">[</span>i<span class="hl opt">])) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>up_per_day<span class="hl opt">[</span>i<span class="hl opt">]),</span> <span class="hl num">3</span><span class="hl opt">))</span>
            data<span class="hl opt">[</span><span class="hl str">&quot;uptime_per_day&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">(</span>t_uptime<span class="hl opt">)</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;overall&quot;</span><span class="hl opt">] =</span> <span class="hl kwb">str</span><span class="hl opt">(</span><span class="hl kwb">round</span><span class="hl opt">(</span><span class="hl num">100</span><span class="hl opt">*(</span><span class="hl kwb">float</span><span class="hl opt">(</span>uptime_total<span class="hl opt">) -</span> <span class="hl kwb">float</span><span class="hl opt">(</span>downtime_total<span class="hl opt">)) /</span> <span class="hl kwb">float</span><span class="hl opt">(</span>uptime_total<span class="hl opt">),</span> <span class="hl num">3</span><span class="hl opt">))+</span><span class="hl str">&quot;%&quot;</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;timestamp&quot;</span><span class="hl opt">] = {</span><span class="hl str">&quot;unix&quot;</span><span class="hl opt">:</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">(),</span> <span class="hl str">&quot;human&quot;</span><span class="hl opt">:</span> datetime<span class="hl opt">.</span>datetime<span class="hl opt">.</span><span class="hl kwd">now</span><span class="hl opt">().</span><span class="hl kwd">strftime</span><span class="hl opt">(</span><span class="hl str">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="hl opt">)}</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;outages_per_day&quot;</span><span class="hl opt">] =</span> outages_per_day
        <span class="hl kwb">open</span><span class="hl opt">(</span><span class="hl str">&quot;../services.json&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">).</span><span class="hl kwd">write</span><span class="hl opt">(</span>json<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">({</span><span class="hl str">&quot;overall&quot;</span><span class="hl opt">:</span> data<span class="hl opt">,</span> <span class="hl str">&quot;per_service&quot;</span><span class="hl opt">:</span> cdata<span class="hl opt">}))</span>

<span class="hl kwa">def</span> <span class="hl kwd">main</span><span class="hl opt">():</span>
    a <span class="hl opt">=</span> <span class="hl kwd">Pingdomrun</span><span class="hl opt">()</span>
    a<span class="hl opt">.</span><span class="hl kwd">run</span><span class="hl opt">()</span>


<span class="hl kwa">if</span> __name__ <span class="hl opt">==</span> <span class="hl str">'__main__'</span><span class="hl opt">:</span>
    <span class="hl kwd">main</span><span class="hl opt">()</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.8, http://www.andre-simon.de/-->
