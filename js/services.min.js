var notifications_enabled=false,shown_notifications=Array();function cancelnotification(a){$.each(shown_notifications["closenotify"+a],function(b,c){c.cancel()})}function refresh_popovers(){var b=0,f=[],c,g,d,e=$("body").data("pagerefresh-data").content;if(!(e instanceof Object)){return}for(var a in e.per_service){b+=1;d=e.per_service[a];if(d.lasterrortime>0){c=moment(d.lasterrortime*1000).fromNow()}else{c="-"}if(d.lasttesttime>0){g=moment(d.lasttesttime*1000).fromNow()}else{g="-"}f[a]="<b>Status: "+d.status+"</b><br>Test method: "+d.type+"<br>Test interval: "+d.resolution+" minutes<br>Last error "+c+"<br>Last check "+g}$(".check-popover").each(function(h){$(this).data("content",f[$(this).data("service-id")]);hide_popovers($(this));$(this).popover({placement:popover_placement})})}function fetch_data(){function j(a,s,r){a.attr("rel","popover");a.attr("data-original-title",s);a.attr("data-content",r);hide_popovers(a);a.popover({placement:popover_placement})}var b=0,n=0,l=0,f=false,g,h,q,o=$("body").data("pagerefresh-data").content;$("#checks-overview-tbody").empty();$("#checks-summary-tbody").empty();for(var i in o.per_service){b+=1;var k=o.per_service[i],p="";for(var m in k.dates){g="";h="";q=k.dates[m];if(q.u>0.999){g="green"}else{if(q.u>0.98){g="yellow"}else{g="red"}}if(q.u==1){h="Uptime: 100% - perfect record."}else{h="Uptime: "+Math.floor(100000*q.u)/1000+"%<br> Downtime: "+q.down+" seconds<br>Total uptime: "+q.up+" seconds."}if(q.totalup==0){g="grey";h="No data available. Either test was paused or it was created after this date."}p+='<td class="check-day" rel="popover" data-original-title="More information" data-content="'+h+'"><span class="serviceicon '+g+'">'+g+"</span></td>"}if(k.status=="up"&&notifications_enabled){if(shown_notifications[i]){shown_notifications[i]["notification"].cancel();shown_notifications[i]["up"]=true}}if(k.status=="down"){n++;if(notifications_enabled){var e=false;for(var c in shown_notifications){if(i==c&&!shown_notifications[i]["up"]){e=true}}if(!e){if(l>2){var d=webkitNotifications.createNotification("","Other services down too","More services are down too. You'll not get further notices this time.");if(!f){d.ondisplay=function(){var a=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+a+");",5000);shown_notifications["closenotify"+a]=$(this)};d.show();f=true}}else{var d=webkitNotifications.createNotification("","Service "+k.name+" is down","Service "+k.name+" went down "+moment(k.lasterrortime*1000).fromNow());d.ondisplay=function(){var a=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+a+");",5000);shown_notifications["closenotify"+a]=$(this)};d.show();l+=1}shown_notifications[i]={notification:d,timestamp:(new Date()).getTime(),up:false}}}}h="";$("#checks-overview-tbody").append('<tr><td class="check-status check-popover" rel="popover" data-service-id="'+i+'" data-original-title="'+k.name+'" data-content="'+h+'"><span class="serviceicon status '+k.status+'"></span></td><td class="check-name"><a href="/page/service-details?id='+i+'">'+k.name+'</a></td><td style="width:50px" class="response-sparkline" id="full_table_'+i+'_sparkline" data-check-id="'+i+'"></td>'+p+"</tr>");$("#checks-summary-tbody").append('<tr><td class="check-name"><a href="/page/service-details?id='+i+'">'+k.name+'</a></td><td class="check-status check-popover" data-service-id="'+i+'" rel="popover" data-original-title="'+k.name+'" data-content="'+h+'"><span class="serviceicon status '+k.status+'"></span></td><td style="width:50px" class="response-sparkline" id="summary_table_'+i+'_sparkline" data-check-id="'+i+'"></td><td style="width:50px" class="uptime-sparkline" id="summary_table_'+i+'_uptime_sparkline" data-check-id="'+i+'"></td></tr>')}if(n==0){$("#status-text").html("Everything is running normally")}else{if(n==1){$("#status-text").html("Just one service is down right now")}else{$("#status-text").html(n+" services are down right now")}}$(".uptime-sparkline").each(function(s){var v=Raphael.fromJquery($(this)),u=[];$.each(o.per_service[$(this).data("check-id")].dates,function(w,x){u.push(x.u)});v.sparkline(u);var t=Math.min.apply(Math,u),a=Math.max.apply(Math,u);var r="Highest uptime: "+Math.floor(a*100*1000)/1000+"%<br>Lowest uptime: "+Math.floor(t*100*1000)/1000+"%";j($(this),"Uptime",r)});$(".response-sparkline").each(function(s){var v=Raphael.fromJquery($(this)),u=o.per_service[$(this).data("check-id")].avgms;v.sparkline(u);var t=Math.min.apply(Math,u),a=Math.max.apply(Math,u);var r="Highest response time: "+a+"ms<br>Lowest response time: "+t+"ms";j($(this),"Response times",r)});$(".check-day-title").each(function(r){var a="Uptime: "+o.overall.uptime_per_day[r]+"%";if(o.overall.outages_per_day[r]>0){a+="<br>Number of outages: "+o.overall.outages_per_day[r]+" (even short ones count)"}$(this).html(o.overall.day_titles[r][2]);j($(this),o.overall.day_titles[r][2],a)});refresh_popovers();hide_popovers();$("[rel=popover]").popover({placement:popover_placement})}$(document).ready(function(){$("#update_data").pagerefresh({short_timeout:1*60,long_timeout:15*60,filewatch:"services.json"});setInterval("refresh_popovers();",1000*60);var a=$("#notification_permissions");a.hide();if(window.webkitNotifications){if(window.webkitNotifications.checkPermission()==1){a.show();a.click(function(){a.addClass("disabled");window.webkitNotifications.requestPermission(function(){a.html("Done");setTimeout('$("#notification_permissions").hide();',1000)})})}else{if(window.webkitNotifications.checkPermission()==0){notifications_enabled=true}}}});