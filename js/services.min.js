var notifications_enabled=false,shown_notifications=Array();function cancelnotification(a){$.each(shown_notifications["closenotify"+a],function(b,c){c.cancel()})}function refresh_popovers(){var b=0,f=[],c,g,d,e=$("body").data("pagerefresh-data").content;if(!(e instanceof Object)){return}for(var a in e.per_service){b+=1;d=e.per_service[a];if(d.lasterrortime>0){c=moment(d.lasterrortime*1000).fromNow()}else{c="-"}if(d.lasttesttime>0){g=moment(d.lasttesttime*1000).fromNow()}else{g="-"}f[a]="<b>Status: "+d.status+"</b><br>Test method: "+d.type+"<br>Test interval: "+d.resolution+" minutes<br>Last error "+c+"<br>Last check "+g}$(".check-popover").each(function(h){$(this).data("content",f[$(this).data("service-id")]);$(this).popover("hide");$(this).popover({placement:popover_placement})})}function fetch_data(){function j(a,t,s){a.attr("rel","popover");a.attr("data-original-title",t);a.attr("data-content",s);a.popover("hide");a.popover({placement:popover_placement})}var b=0,n=0,l=0,f=false,g,h,r,p=$("body").data("pagerefresh-data").content;for(var o in p.overall){if($("#"+o)!=null){$("#"+o).html(p.overall[o])}}$("#checks-overview-tbody").empty();$("#checks-summary-tbody").empty();for(var i in p.per_service){b+=1;var k=p.per_service[i],q="";for(var m in k.dates){g="";h="";r=k.dates[m];if(r.u>0.999){g="green"}else{if(r.u>0.98){g="yellow"}else{g="red"}}if(r.u==1){h="Uptime: 100% - perfect record."}else{h="Uptime: "+Math.floor(100000*r.u)/1000+"%<br> Downtime: "+r.down+" seconds<br>Total uptime: "+r.up+" seconds."}if(r.totalup==0){g="grey";h="No data available. Either test was paused or it was created after this date."}q+='<td class="check-day" rel="popover" data-original-title="More information" data-content="'+h+'"><span class="icon '+g+'">'+g+"</span></td>"}if(k.status=="up"&&notifications_enabled){if(shown_notifications[i]){shown_notifications[i]["notification"].cancel();shown_notifications[i]["up"]=true}}if(k.status=="down"){n++;if(notifications_enabled){var e=false;for(var c in shown_notifications){if(i==c&&!shown_notifications[i]["up"]){e=true}}if(!e){if(l>2){var d=webkitNotifications.createNotification("","Other services down too","More services are down too. You'll not get further notices this time.");if(!f){d.ondisplay=function(){var a=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+a+");",5000);shown_notifications["closenotify"+a]=$(this)};d.show();f=true}}else{var d=webkitNotifications.createNotification("","Service "+k.name+" is down","Service "+k.name+" went down "+moment(k.lasterrortime*1000).fromNow());d.ondisplay=function(){var a=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+a+");",5000);shown_notifications["closenotify"+a]=$(this)};d.show();l+=1}shown_notifications[i]={notification:d,timestamp:(new Date()).getTime(),up:false}}}}h="";$("#checks-overview-tbody").append('<tr><td class="check-status check-popover" rel="popover" data-service-id="'+i+'" data-original-title="'+k.name+'" data-content="'+h+'"><span class="status '+k.status+'"></span></td><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+i+'">'+k.name+'</a></td><td style="width:50px" class="response-sparkline" id="full_table_'+i+'_sparkline" data-check-id="'+i+'"></td>'+q+"</tr>");$("#checks-summary-tbody").append('<tr><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+i+'">'+k.name+'</a></td><td class="check-status check-popover" data-service-id="'+i+'" rel="popover" data-original-title="'+k.name+'" data-content="'+h+'"><span class="status '+k.status+'"></span></td><td style="width:50px" class="response-sparkline" id="summary_table_'+i+'_sparkline" data-check-id="'+i+'"></td><td style="width:50px" class="uptime-sparkline" id="summary_table_'+i+'_uptime_sparkline" data-check-id="'+i+'"></td></tr>')}if(n==0){$("#status-text").html("Everything is running normally")}else{if(n==1){$("#status-text").html("Just one service is down right now")}else{$("#status-text").html(n+" services are down right now")}}$(".uptime-sparkline").each(function(t){var w=Raphael.fromJquery($(this)),v=[];$.each(p.per_service[$(this).data("check-id")].dates,function(x,y){v.push(y.u)});w.sparkline(v);var u=Math.min.apply(Math,v),a=Math.max.apply(Math,v);var s="Highest uptime: "+Math.floor(a*100*1000)/1000+"%<br>Lowest uptime: "+Math.floor(u*100*1000)/1000+"%";j($(this),"Uptime",s)});$(".response-sparkline").each(function(t){var w=Raphael.fromJquery($(this)),v=p.per_service[$(this).data("check-id")].avgms;w.sparkline(v);var u=Math.min.apply(Math,v),a=Math.max.apply(Math,v);var s="Highest response time: "+a+"ms<br>Lowest response time: "+u+"ms";j($(this),"Response times",s)});$(".check-day-title").each(function(s){var a="Uptime: "+p.overall.uptime_per_day[s]+"%";if(p.overall.outages_per_day[s]>0){a+="<br>Number of outages: "+p.overall.outages_per_day[s]+" (even short ones count)"}$(this).html(p.overall.day_titles[s][2]);j($(this),p.overall.day_titles[s][2],a)});refresh_popovers();$("[rel=popover]").popover("hide");$("[rel=popover]").popover({placement:popover_placement})}$(document).ready(function(){$("#update_data").pagerefresh({short_timeout:1*60,long_timeout:15*60,filewatch:"services.json"});setInterval("refresh_popovers();",1000*60);var a=$("#notification_permissions");a.hide();if(window.webkitNotifications){if(window.webkitNotifications.checkPermission()==1){a.show();a.click(function(){a.addClass("disabled");window.webkitNotifications.requestPermission(function(){a.html("Done");setTimeout('$("#notification_permissions").hide();',1000)})})}else{if(window.webkitNotifications.checkPermission()==0){notifications_enabled=true}}}});