var services_data;var services_data_ajax;var update_next_reload_timeout,status_timestamp_interval,update_data_timeout;function update_next_reload(a){clearTimeout(update_next_reload_timeout);if(moment(a)<moment()){$("#next-reload").html("Next reload right now")}else{$("#next-reload").html("Next reload "+moment(a).fromNow());update_next_reload_timeout=setTimeout("update_next_reload("+a+");",1000)}}function refresh_popovers(){var a=0,d=new Array(),b,e;for(service in services_data.per_service){a+=1;var c=services_data.per_service[service];if(c.lasterrortime>0){b=moment(c.lasterrortime*1000).fromNow()}else{b="-"}if(c.lasttesttime>0){e=moment(c.lasttesttime*1000).fromNow()}else{e="-"}d[service]="<b>Status: "+c.status+"</b><br>Test method: "+c.type+"<br>Test interval: "+c.resolution+" minutes<br>Last error "+b+"<br>Last check "+e}$(".check-popover").each(function(f){$(this).data("content",d[$(this).data("service-id")]);$(this).popover()})}function process_data(){var b=0,g=0;for(var h in services_data.overall){if($("#"+h)!=null){$("#"+h).html(services_data.overall[h])}}$("#checks-overview-tbody").empty();$("#checks-summary-tbody").empty();$("#status-timestamp").html(moment(services_data.overall.timestamp.unix*1000).fromNow()+".");clearInterval(status_timestamp_interval);status_timestamp_interval=setInterval('$("#status-timestamp").html(moment(services_data.overall.timestamp.unix*1000).fromNow()+".");',1000);update_next_reload((new Date()).getTime()+15*60*1000);for(service in services_data.per_service){b+=1;var e=services_data.per_service[service],j="";for(var f in e.dates){var c="",d="",i=e.dates[f];if(i.u>0.999){c="green"}else{if(i.u>0.98){c="yellow"}else{c="red"}}if(i.u==1){d="Uptime: 100% - perfect record."}else{d="Uptime: "+Math.floor(100000*i.u)/1000+"%<br> Downtime: "+i.down+" seconds<br>Total uptime: "+i.up+" seconds."}if(i.totalup==0){c="grey";d="No data available. Either test was paused or it was created after this date."}j+='<td class="check-day" rel="popover" data-original-title="More information" data-content="'+d+'"><span class="icon '+c+'">'+c+"</span></td>"}if(e.status=="down"){g++}d="";$("#checks-overview-tbody").append('<tr><td class="check-status check-popover" rel="popover" data-service-id="'+service+'" data-original-title="'+e.name+'" data-content="'+d+'" data-placement="right"><span class="status '+e.status+'"></span></td><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+service+'">'+e.name+'</a></td><td style="width:50px" class="response-sparkline" id="full_table_'+service+'_sparkline" data-check-id="'+service+'"></td>'+j+"</tr>");$("#checks-summary-tbody").append('<tr><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+service+'">'+e.name+'</a></td><td class="check-status check-popover" data-service-id="'+service+'" rel="popover" data-original-title="'+e.name+'" data-content="'+d+'" data-placement="right"><span class="status '+e.status+'"></span></td><td style="width:50px" class="response-sparkline" id="summary_table_'+service+'_sparkline" data-check-id="'+service+'"></td><td style="width:50px" class="uptime-sparkline" id="summary_table_'+service+'_uptime_sparkline" data-check-id="'+service+'"></td></tr>')}if(g==0){$("#status-text").html("Everything is running normally")}else{if(g==1){$("#status-text").html("Just one service is down right now")}else{$("#status-text").html(g+" services are down right now")}}$(".uptime-sparkline").each(function(k){var n=Raphael.fromJquery($(this)),m=[];$.each(services_data.per_service[$(this).data("check-id")].dates,function(o,p){m.push(p.u)});n.sparkline(m);var l=Math.min.apply(Math,m),a=Math.max.apply(Math,m);d="Highest uptime: "+Math.floor(a*100*1000)/1000+"%<br>Lowest uptime: "+Math.floor(l*100*1000)/1000+"%";add_popover($(this),"Uptime",d)});$(".response-sparkline").each(function(l){var o=Raphael.fromJquery($(this)),n=services_data.per_service[$(this).data("check-id")].avgms;o.sparkline(n);var m=Math.min.apply(Math,n),a=Math.max.apply(Math,n);var k="Highest response time: "+a+"ms<br>Lowest response time: "+m+"ms";add_popover($(this),"Response times",k)});$(".check-day-title").each(function(k){var a="Uptime: "+services_data.overall.uptime_per_day[k]+"%";if(services_data.overall.outages_per_day[k]>0){a+="<br>Number of outages: "+services_data.overall.outages_per_day[k]+" (even short ones count)"}$(this).html(services_data.overall.day_titles[k][2]);add_popover($(this),services_data.overall.day_titles[k][2],a)});refresh_popovers();$("[rel=popover]").popover();$("#progress-indicator").hide()}function add_popover(a,c,b){a.attr("rel","popover");a.attr("data-original-title",c);a.attr("data-content",b);a.popover()}function update_data(){$("#progress-indicator").show();$("#update_now_button").addClass("disabled");clearTimeout(update_data_timeout);$.getJSON("/services.json?timestamp="+((new Date()).getTime()/10),function(a){services_data=a;process_data();update_data_timeout=setTimeout("update_data();",1000*60*15);$("#update_now_button").removeClass("disabled")})}$(document).ready(function(){update_data();setInterval("refresh_popovers();",1000*60);$("#update_now_button").click(function(){update_data()})});