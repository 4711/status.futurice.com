var notifications_enabled=false,shown_notifications=Array();function cancelnotification(a){$.each(shown_notifications["closenotify"+a],function(b,c){c.cancel()})}function refresh_popovers(){var b=0,f=[],c,g,d,e=$("body").data("services_data");if(!(e instanceof Object)){return}for(var a in e.per_service){b+=1;d=e.per_service[a];if(d.lasterrortime>0){c=moment(d.lasterrortime*1000).fromNow()}else{c="-"}if(d.lasttesttime>0){g=moment(d.lasttesttime*1000).fromNow()}else{g="-"}f[a]="<b>Status: "+d.status+"</b><br>Test method: "+d.type+"<br>Test interval: "+d.resolution+" minutes<br>Last error "+c+"<br>Last check "+g}$(".check-popover").each(function(h){$(this).data("content",f[$(this).data("service-id")]);$(this).popover()})}function fetch_data(){function a(){function j(s,u,t){s.attr("rel","popover");s.attr("data-original-title",u);s.attr("data-content",t);s.popover()}var b=0,n=0,l=0,f=false,g,h,r,p=$("body").data("services_data");for(var o in p.overall){if($("#"+o)!=null){$("#"+o).html(p.overall[o])}}$("#checks-overview-tbody").empty();$("#checks-summary-tbody").empty();for(var i in p.per_service){b+=1;var k=p.per_service[i],q="";for(var m in k.dates){g="";h="";r=k.dates[m];if(r.u>0.999){g="green"}else{if(r.u>0.98){g="yellow"}else{g="red"}}if(r.u==1){h="Uptime: 100% - perfect record."}else{h="Uptime: "+Math.floor(100000*r.u)/1000+"%<br> Downtime: "+r.down+" seconds<br>Total uptime: "+r.up+" seconds."}if(r.totalup==0){g="grey";h="No data available. Either test was paused or it was created after this date."}q+='<td class="check-day" rel="popover" data-original-title="More information" data-content="'+h+'"><span class="icon '+g+'">'+g+"</span></td>"}if(k.status=="up"&&notifications_enabled){if(shown_notifications[i]){shown_notifications[i]["notification"].cancel();shown_notifications[i]["up"]=true}}if(k.status=="down"){n++;if(notifications_enabled){var e=false;for(var c in shown_notifications){if(i==c&&!shown_notifications[i]["up"]){e=true}}if(!e){if(l>2){var d=webkitNotifications.createNotification("","Other services down too","More services are down too. You'll not get further notices this time.");if(!f){d.ondisplay=function(){var s=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+s+");",5000);shown_notifications["closenotify"+s]=$(this)};d.show();f=true}}else{var d=webkitNotifications.createNotification("","Service "+k.name+" is down","Service "+k.name+" went down "+moment(k.lasterrortime*1000).fromNow());d.ondisplay=function(){var s=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+s+");",5000);shown_notifications["closenotify"+s]=$(this)};d.show();l+=1}shown_notifications[i]={notification:d,timestamp:(new Date()).getTime(),up:false}}}}h="";$("#checks-overview-tbody").append('<tr><td class="check-status check-popover" rel="popover" data-service-id="'+i+'" data-original-title="'+k.name+'" data-content="'+h+'" data-placement="right"><span class="status '+k.status+'"></span></td><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+i+'">'+k.name+'</a></td><td style="width:50px" class="response-sparkline" id="full_table_'+i+'_sparkline" data-check-id="'+i+'"></td>'+q+"</tr>");$("#checks-summary-tbody").append('<tr><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+i+'">'+k.name+'</a></td><td class="check-status check-popover" data-service-id="'+i+'" rel="popover" data-original-title="'+k.name+'" data-content="'+h+'" data-placement="right"><span class="status '+k.status+'"></span></td><td style="width:50px" class="response-sparkline" id="summary_table_'+i+'_sparkline" data-check-id="'+i+'"></td><td style="width:50px" class="uptime-sparkline" id="summary_table_'+i+'_uptime_sparkline" data-check-id="'+i+'"></td></tr>')}if(n==0){$("#status-text").html("Everything is running normally")}else{if(n==1){$("#status-text").html("Just one service is down right now")}else{$("#status-text").html(n+" services are down right now")}}$(".uptime-sparkline").each(function(u){var x=Raphael.fromJquery($(this)),w=[];$.each(p.per_service[$(this).data("check-id")].dates,function(y,z){w.push(z.u)});x.sparkline(w);var v=Math.min.apply(Math,w),s=Math.max.apply(Math,w);var t="Highest uptime: "+Math.floor(s*100*1000)/1000+"%<br>Lowest uptime: "+Math.floor(v*100*1000)/1000+"%";j($(this),"Uptime",t)});$(".response-sparkline").each(function(u){var x=Raphael.fromJquery($(this)),w=p.per_service[$(this).data("check-id")].avgms;x.sparkline(w);var v=Math.min.apply(Math,w),s=Math.max.apply(Math,w);var t="Highest response time: "+s+"ms<br>Lowest response time: "+v+"ms";j($(this),"Response times",t)});$(".check-day-title").each(function(t){var s="Uptime: "+p.overall.uptime_per_day[t]+"%";if(p.overall.outages_per_day[t]>0){s+="<br>Number of outages: "+p.overall.outages_per_day[t]+" (even short ones count)"}$(this).html(p.overall.day_titles[t][2]);j($(this),p.overall.day_titles[t][2],s)});refresh_popovers();$("[rel=popover]").popover()}$.getJSON("/services.json?timestamp="+Math.floor((new Date()).getTime()/100),function(c){try{var b=$("body").data("services_data").overall.timestamp.unix;if(b==c.overall.timestamp.unix){$("#update_data").pagerefresh("fetch_done",c.overall.timestamp.unix*1000);return}}catch(d){}$("body").data("services_data",c);a();$("#update_data").pagerefresh("fetch_done",c.overall.timestamp.unix*1000)})}$(document).ready(function(){$("#update_data").pagerefresh({short_timeout:1*60,long_timeout:15*60,filewatch:"services.json"});setInterval("refresh_popovers();",1000*60);$("#notification_permissions").hide();if(window.webkitNotifications){if(window.webkitNotifications.checkPermission()==1){$("#notification_permissions").show();$("#notification_permissions").click(function(){$("#notification_permissions").addClass("disabled");window.webkitNotifications.requestPermission(function(){$("#notification_permissions").html("Done");setTimeout('$("#notification_permissions").hide();',1000)})})}else{if(window.webkitNotifications.checkPermission()==0){notifications_enabled=true}}}});