var paused=false,refresh_interval=1;function update_next_reload(){var a=$("#next-reload").data("reload-timestamp");if(moment(a)<moment()){$("#next-reload").html("Next reload right now");fetch_data()}else{$("#next-reload").html("Next reload "+moment(a).fromNow())}setTimeout("update_next_reload();",1000)}function refresh_popovers(){var b=0,f=[],c,g,d,e=$("body").data("services_data");if(!(e instanceof Array)){return}for(var a in e.per_service){b+=1;d=e.per_service[a];if(d.lasterrortime>0){c=moment(d.lasterrortime*1000).fromNow()}else{c="-"}if(d.lasttesttime>0){g=moment(d.lasttesttime*1000).fromNow()}else{g="-"}f[a]="<b>Status: "+d.status+"</b><br>Test method: "+d.type+"<br>Test interval: "+d.resolution+" minutes<br>Last error "+c+"<br>Last check "+g}$(".check-popover").each(function(h){$(this).data("content",f[$(this).data("service-id")]);$(this).popover()})}function fetch_data(){function a(){function f(n,p,o){n.attr("rel","popover");n.attr("data-original-title",p);n.attr("data-content",o);n.popover()}var b=0,i=0,c,d,m,j=$("body").data("services_data");for(var k in j.overall){if($("#"+k)!=null){$("#"+k).html(j.overall[k])}}$("#checks-overview-tbody").empty();$("#checks-summary-tbody").empty();$("#status-timestamp").html(moment(j.overall.timestamp.unix*1000).fromNow()+".");clearInterval($("body").data("status_timestamp_interval"));$("body").data("status_timestamp_interval",setInterval('$("#status-timestamp").html(moment($("body").data("services_data").overall.timestamp.unix*1000).fromNow()+".");',1000));for(var e in j.per_service){b+=1;var g=j.per_service[e],l="";for(var h in g.dates){c="";d="";m=g.dates[h];if(m.u>0.999){c="green"}else{if(m.u>0.98){c="yellow"}else{c="red"}}if(m.u==1){d="Uptime: 100% - perfect record."}else{d="Uptime: "+Math.floor(100000*m.u)/1000+"%<br> Downtime: "+m.down+" seconds<br>Total uptime: "+m.up+" seconds."}if(m.totalup==0){c="grey";d="No data available. Either test was paused or it was created after this date."}l+='<td class="check-day" rel="popover" data-original-title="More information" data-content="'+d+'"><span class="icon '+c+'">'+c+"</span></td>"}if(g.status=="down"){i++}d="";$("#checks-overview-tbody").append('<tr><td class="check-status check-popover" rel="popover" data-service-id="'+e+'" data-original-title="'+g.name+'" data-content="'+d+'" data-placement="right"><span class="status '+g.status+'"></span></td><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+e+'">'+g.name+'</a></td><td style="width:50px" class="response-sparkline" id="full_table_'+e+'_sparkline" data-check-id="'+e+'"></td>'+l+"</tr>");$("#checks-summary-tbody").append('<tr><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+e+'">'+g.name+'</a></td><td class="check-status check-popover" data-service-id="'+e+'" rel="popover" data-original-title="'+g.name+'" data-content="'+d+'" data-placement="right"><span class="status '+g.status+'"></span></td><td style="width:50px" class="response-sparkline" id="summary_table_'+e+'_sparkline" data-check-id="'+e+'"></td><td style="width:50px" class="uptime-sparkline" id="summary_table_'+e+'_uptime_sparkline" data-check-id="'+e+'"></td></tr>')}if(i==0){$("#status-text").html("Everything is running normally")}else{if(i==1){$("#status-text").html("Just one service is down right now")}else{$("#status-text").html(i+" services are down right now")}}$(".uptime-sparkline").each(function(p){var s=Raphael.fromJquery($(this)),r=[];$.each(j.per_service[$(this).data("check-id")].dates,function(t,u){r.push(u.u)});s.sparkline(r);var q=Math.min.apply(Math,r),n=Math.max.apply(Math,r);var o="Highest uptime: "+Math.floor(n*100*1000)/1000+"%<br>Lowest uptime: "+Math.floor(q*100*1000)/1000+"%";f($(this),"Uptime",o)});$(".response-sparkline").each(function(p){var s=Raphael.fromJquery($(this)),r=j.per_service[$(this).data("check-id")].avgms;s.sparkline(r);var q=Math.min.apply(Math,r),n=Math.max.apply(Math,r);var o="Highest response time: "+n+"ms<br>Lowest response time: "+q+"ms";f($(this),"Response times",o)});$(".check-day-title").each(function(o){var n="Uptime: "+j.overall.uptime_per_day[o]+"%";if(j.overall.outages_per_day[o]>0){n+="<br>Number of outages: "+j.overall.outages_per_day[o]+" (even short ones count)"}$(this).html(j.overall.day_titles[o][2]);f($(this),j.overall.day_titles[o][2],n)});refresh_popovers();$("[rel=popover]").popover()}$("#next-reload").data("reload-timestamp",(new Date()).getTime()+refresh_interval*60*1000);update_twitter();$("#progress-indicator").show();$("#update_now_button").addClass("disabled");$.getJSON("/services.json?timestamp="+Math.floor((new Date()).getTime()/100),function(c){setTimeout('$("#update_now_button").removeClass("disabled");$("#progress-indicator").hide();',1000);try{var b=$("body").data("services_data").overall.timestamp.unix;if(b==c.overall.timestamp.unix){return}}catch(d){}$("body").data("services_data",c);a()})}$(document).ready(function(){$(window).blur(function(){paused=true;refresh_interval=15;$("#next-reload").data("reload-timestamp",(new Date()).getTime()+refresh_interval*60*1000)});$(window).focus(function(){$("#next-reload").data("reload-timestamp",$("#next-reload").data("reload-timestamp")-((refresh_interval-1)*60*1000));refresh_interval=1;paused=false});$("#next-reload").data("reload-timestamp",0);update_next_reload();setInterval("refresh_popovers();",1000*60);$("#update_now_button").click(function(){fetch_data()})});