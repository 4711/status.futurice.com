var notifications_enabled=false,shown_notifications=Array();function cancelnotification(a){$.each(shown_notifications["closenotify"+a],function(b,c){c.cancel()})}function refresh_popovers(){var b=0,f=[],c,g,d,e=$("body").data("services_data");if(!(e instanceof Object)){return}for(var a in e.per_service){b+=1;d=e.per_service[a];if(d.lasterrortime>0){c=moment(d.lasterrortime*1000).fromNow()}else{c="-"}if(d.lasttesttime>0){g=moment(d.lasttesttime*1000).fromNow()}else{g="-"}f[a]="<b>Status: "+d.status+"</b><br>Test method: "+d.type+"<br>Test interval: "+d.resolution+" minutes<br>Last error "+c+"<br>Last check "+g}$(".check-popover").each(function(h){$(this).data("content",f[$(this).data("service-id")]);$(this).popover("hide");$(this).popover({placement:popover_placement})})}function fetch_data(a){function c(){function l(u,w,v){u.attr("rel","popover");u.attr("data-original-title",w);u.attr("data-content",v);u.popover("hide");u.popover({placement:popover_placement})}var d=0,p=0,n=0,h=false,i,j,t,r=$("body").data("services_data");for(var q in r.overall){if($("#"+q)!=null){$("#"+q).html(r.overall[q])}}$("#checks-overview-tbody").empty();$("#checks-summary-tbody").empty();for(var k in r.per_service){d+=1;var m=r.per_service[k],s="";for(var o in m.dates){i="";j="";t=m.dates[o];if(t.u>0.999){i="green"}else{if(t.u>0.98){i="yellow"}else{i="red"}}if(t.u==1){j="Uptime: 100% - perfect record."}else{j="Uptime: "+Math.floor(100000*t.u)/1000+"%<br> Downtime: "+t.down+" seconds<br>Total uptime: "+t.up+" seconds."}if(t.totalup==0){i="grey";j="No data available. Either test was paused or it was created after this date."}s+='<td class="check-day" rel="popover" data-original-title="More information" data-content="'+j+'"><span class="icon '+i+'">'+i+"</span></td>"}if(m.status=="up"&&notifications_enabled){if(shown_notifications[k]){shown_notifications[k]["notification"].cancel();shown_notifications[k]["up"]=true}}if(m.status=="down"){p++;if(notifications_enabled){var g=false;for(var e in shown_notifications){if(k==e&&!shown_notifications[k]["up"]){g=true}}if(!g){if(n>2){var f=webkitNotifications.createNotification("","Other services down too","More services are down too. You'll not get further notices this time.");if(!h){f.ondisplay=function(){var u=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+u+");",5000);shown_notifications["closenotify"+u]=$(this)};f.show();h=true}}else{var f=webkitNotifications.createNotification("","Service "+m.name+" is down","Service "+m.name+" went down "+moment(m.lasterrortime*1000).fromNow());f.ondisplay=function(){var u=(new Date()).getTime()+Math.random();setTimeout("cancelnotification("+u+");",5000);shown_notifications["closenotify"+u]=$(this)};f.show();n+=1}shown_notifications[k]={notification:f,timestamp:(new Date()).getTime(),up:false}}}}j="";$("#checks-overview-tbody").append('<tr><td class="check-status check-popover" rel="popover" data-service-id="'+k+'" data-original-title="'+m.name+'" data-content="'+j+'"><span class="status '+m.status+'"></span></td><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+k+'">'+m.name+'</a></td><td style="width:50px" class="response-sparkline" id="full_table_'+k+'_sparkline" data-check-id="'+k+'"></td>'+s+"</tr>");$("#checks-summary-tbody").append('<tr><td class="check-name"><a target="_parent" href="http://status.futurice.com/'+k+'">'+m.name+'</a></td><td class="check-status check-popover" data-service-id="'+k+'" rel="popover" data-original-title="'+m.name+'" data-content="'+j+'"><span class="status '+m.status+'"></span></td><td style="width:50px" class="response-sparkline" id="summary_table_'+k+'_sparkline" data-check-id="'+k+'"></td><td style="width:50px" class="uptime-sparkline" id="summary_table_'+k+'_uptime_sparkline" data-check-id="'+k+'"></td></tr>')}if(p==0){$("#status-text").html("Everything is running normally")}else{if(p==1){$("#status-text").html("Just one service is down right now")}else{$("#status-text").html(p+" services are down right now")}}$(".uptime-sparkline").each(function(w){var z=Raphael.fromJquery($(this)),y=[];$.each(r.per_service[$(this).data("check-id")].dates,function(A,B){y.push(B.u)});z.sparkline(y);var x=Math.min.apply(Math,y),u=Math.max.apply(Math,y);var v="Highest uptime: "+Math.floor(u*100*1000)/1000+"%<br>Lowest uptime: "+Math.floor(x*100*1000)/1000+"%";l($(this),"Uptime",v)});$(".response-sparkline").each(function(w){var z=Raphael.fromJquery($(this)),y=r.per_service[$(this).data("check-id")].avgms;z.sparkline(y);var x=Math.min.apply(Math,y),u=Math.max.apply(Math,y);var v="Highest response time: "+u+"ms<br>Lowest response time: "+x+"ms";l($(this),"Response times",v)});$(".check-day-title").each(function(v){var u="Uptime: "+r.overall.uptime_per_day[v]+"%";if(r.overall.outages_per_day[v]>0){u+="<br>Number of outages: "+r.overall.outages_per_day[v]+" (even short ones count)"}$(this).html(r.overall.day_titles[v][2]);l($(this),r.overall.day_titles[v][2],u)});refresh_popovers();$("[rel=popover]").popover("hide");$("[rel=popover]").popover({placement:popover_placement})}if(a){var b=$("body").data("services_data");$("#update_data").pagerefresh("fetch_done",b.overall.timestamp.unix*1000);c()}else{$.getJSON("/data/services.json?timestamp="+Math.floor((new Date()).getTime()/100),function(f){try{var d=$("body").data("services_data").overall.timestamp.unix;if(d==f.overall.timestamp.unix){$("#update_data").pagerefresh("fetch_done",f.overall.timestamp.unix*1000);return}}catch(g){}if(localStorage){localStorage.setItem("services_json",JSON.stringify(f))}$("body").data("services_data",f);c();$("#update_data").pagerefresh("fetch_done",f.overall.timestamp.unix*1000)})}}$(document).ready(function(){$("#update_data").pagerefresh({short_timeout:1*60,long_timeout:15*60,filewatch:"services.json"});if(localStorage){var a=localStorage.getItem("services_json");if(a!=null){try{a=JSON.parse(a);$("body").data("services_data",a);fetch_data(true)}catch(c){}}}setInterval("refresh_popovers();",1000*60);var b=$("#notification_permissions");b.hide();if(window.webkitNotifications){if(window.webkitNotifications.checkPermission()==1){b.show();b.click(function(){b.addClass("disabled");window.webkitNotifications.requestPermission(function(){b.html("Done");setTimeout('$("#notification_permissions").hide();',1000)})})}else{if(window.webkitNotifications.checkPermission()==0){notifications_enabled=true}}}});