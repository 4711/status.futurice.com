var notifications_enabled=!1,shown_notifications=[];function cancelnotification(d){$.each(shown_notifications["closenotify"+d],function(d,i){i.cancel()})}
function refresh_popovers(){var d=[],k,i,f,a=$("body").data("pagerefresh-data").content;if(a instanceof Object){for(var g in a.per_service)f=a.per_service[g],k=0<f.lasterrortime?moment(1E3*f.lasterrortime).fromNow():"-",i=0<f.lasttesttime?moment(1E3*f.lasttesttime).fromNow():"-",d[g]="<b>Status: "+f.status+"</b><br>Test method: "+f.type+"<br>Test interval: "+f.resolution+" minutes<br>Last error "+k+"<br>Last check "+i;$(".check-popover").each(function(){$(this).data("content",d[$(this).data("service-id")]);
hide_popovers($(this));$(this).popover({placement:popover_placement})})}}
function fetch_data(){function d(c,a,b){c.attr("rel","popover");c.attr("data-original-title",a);c.attr("data-content",b);hide_popovers(c);c.popover({placement:popover_placement})}var k=0,i=0,f=!1,a,g,j,h=$("body").data("pagerefresh-data").content;$("#checks-overview-tbody").empty();$("#checks-summary-tbody").empty();for(var b in h.per_service){var e=h.per_service[b],l="",m;for(m in e.dates)g=a="",j=e.dates[m],a=0.999<j.u?"green":0.98<j.u?"yellow":"red",g=1==j.u?"Uptime: 100% - perfect record.":"Uptime: "+
Math.floor(1E5*j.u)/1E3+"%<br> Downtime: "+j.down+" seconds<br>Total uptime: "+j.up+" seconds.",0==j.totalup&&(a="grey",g="No data available. Either test was paused or it was created after this date."),l+='<td class="check-day" rel="popover" data-original-title="More information" data-content="'+g+'"><span class="icon '+a+'">'+a+"</span></td>";"up"==e.status&&notifications_enabled&&shown_notifications[b]&&(shown_notifications[b].notification.cancel(),shown_notifications[b].up=!0);if("down"==e.status&&
(k++,notifications_enabled)){a=!1;for(var n in shown_notifications)b==n&&!shown_notifications[b].up&&(a=!0);a||(2<i?(a=webkitNotifications.createNotification("","Other services down too","More services are down too. You'll not get further notices this time."),f||(a.ondisplay=function(){var c=(new Date).getTime()+Math.random();setTimeout("cancelnotification("+c+");",5E3);shown_notifications["closenotify"+c]=$(this)},a.show(),f=!0)):(a=webkitNotifications.createNotification("","Service "+e.name+" is down",
"Service "+e.name+" went down "+moment(1E3*e.lasterrortime).fromNow()),a.ondisplay=function(){var c=(new Date).getTime()+Math.random();setTimeout("cancelnotification("+c+");",5E3);shown_notifications["closenotify"+c]=$(this)},a.show(),i+=1),shown_notifications[b]={notification:a,timestamp:(new Date).getTime(),up:!1})}g="";$("#checks-overview-tbody").append('<tr><td class="check-status check-popover" rel="popover" data-service-id="'+b+'" data-original-title="'+e.name+'" data-content="'+g+'"><span class="status '+
e.status+'"></span></td><td class="check-name"><a href="/page/service-details?id='+b+'">'+e.name+'</a></td><td style="width:50px" class="response-sparkline" id="full_table_'+b+'_sparkline" data-check-id="'+b+'"></td>'+l+"</tr>");$("#checks-summary-tbody").append('<tr><td class="check-name"><a href="/page/service-details?id='+b+'">'+e.name+'</a></td><td class="check-status check-popover" data-service-id="'+b+'" rel="popover" data-original-title="'+e.name+'" data-content="'+g+'"><span class="status '+
e.status+'"></span></td><td style="width:50px" class="response-sparkline" id="summary_table_'+b+'_sparkline" data-check-id="'+b+'"></td><td style="width:50px" class="uptime-sparkline" id="summary_table_'+b+'_uptime_sparkline" data-check-id="'+b+'"></td></tr>')}0==k?$("#status-text").html("Everything is running normally"):1==k?$("#status-text").html("Just one service is down right now"):$("#status-text").html(k+" services are down right now");$(".uptime-sparkline").each(function(){var c=Raphael.fromJquery($(this)),
a=[];$.each(h.per_service[$(this).data("check-id")].dates,function(c,b){a.push(b.u)});c.sparkline(a);var c=Math.min.apply(Math,a),b=Math.max.apply(Math,a),c="Highest uptime: "+Math.floor(1E5*b)/1E3+"%<br>Lowest uptime: "+Math.floor(1E5*c)/1E3+"%";d($(this),"Uptime",c)});$(".response-sparkline").each(function(){var c=Raphael.fromJquery($(this)),a=h.per_service[$(this).data("check-id")].avgms;c.sparkline(a);c=Math.min.apply(Math,a);a="Highest response time: "+Math.max.apply(Math,a)+"ms<br>Lowest response time: "+
c+"ms";d($(this),"Response times",a)});$(".check-day-title").each(function(a){var b="Uptime: "+h.overall.uptime_per_day[a]+"%";0<h.overall.outages_per_day[a]&&(b+="<br>Number of outages: "+h.overall.outages_per_day[a]+" (even short ones count)");$(this).html(h.overall.day_titles[a][2]);d($(this),h.overall.day_titles[a][2],b)});refresh_popovers();hide_popovers();$("[rel=popover]").popover({placement:popover_placement})}
$(document).ready(function(){$("#update_data").pagerefresh({short_timeout:60,long_timeout:900,filewatch:"services.json"});setInterval("refresh_popovers();",6E4);var d=$("#notification_permissions");d.hide();window.webkitNotifications&&(1==window.webkitNotifications.checkPermission()?(d.show(),d.click(function(){d.addClass("disabled");window.webkitNotifications.requestPermission(function(){d.html("Done");setTimeout('$("#notification_permissions").hide();',1E3)})})):0==window.webkitNotifications.checkPermission()&&
(notifications_enabled=!0))});
