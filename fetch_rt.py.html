<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>backend/fetch_rt.py</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl str">&quot;&quot;&quot; This script fetches information from RT </span>
<span class="hl str">(http://bestpractical.com/rt/) mysql database. It works at least with RT </span>
<span class="hl str">3.8. &quot;&quot;&quot;</span>

<span class="hl kwa">from</span> time <span class="hl kwa">import</span> time
<span class="hl kwa">import</span> json
<span class="hl kwa">import</span> MySQLdb
<span class="hl kwa">import</span> logging
<span class="hl kwa">import</span> datetime
<span class="hl kwa">from</span> poster<span class="hl opt">.</span>encode <span class="hl kwa">import</span> multipart_encode
<span class="hl kwa">from</span> poster<span class="hl opt">.</span>streaminghttp <span class="hl kwa">import</span> register_openers
<span class="hl kwa">import</span> urllib2

<span class="hl kwa">import</span> rt_settings

<span class="hl kwa">class</span> RTStats<span class="hl opt">:</span>
    <span class="hl kwa">def</span> <span class="hl kwd">__init__</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        self<span class="hl opt">.</span>username <span class="hl opt">=</span> rt_settings<span class="hl opt">.</span>RT_USERNAME
        self<span class="hl opt">.</span>password <span class="hl opt">=</span> rt_settings<span class="hl opt">.</span>RT_PASSWORD
        self<span class="hl opt">.</span>database <span class="hl opt">=</span> rt_settings<span class="hl opt">.</span>RT_DATABASE
        self<span class="hl opt">.</span>upload_url <span class="hl opt">=</span> rt_settings<span class="hl opt">.</span>UPLOAD_URL
        self<span class="hl opt">.</span>upload_password <span class="hl opt">=</span> rt_settings<span class="hl opt">.</span>UPLOAD_PASSWORD
        self<span class="hl opt">.</span>_db <span class="hl opt">=</span> <span class="hl kwa">None</span>
        <span class="hl kwd">register_openers</span><span class="hl opt">()</span>

    <span class="hl kwb">&#64;property</span>
    <span class="hl kwa">def</span> <span class="hl kwd">db</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Saves database connection instance and automatically </span>
<span class="hl str">            connects if connection is not yet initialized &quot;&quot;&quot;</span>
        <span class="hl kwa">if</span> self<span class="hl opt">.</span>_db <span class="hl kwa">is None</span><span class="hl opt">:</span>
            self<span class="hl opt">.</span>_db <span class="hl opt">=</span> self<span class="hl opt">.</span><span class="hl kwd">connect</span><span class="hl opt">()</span>
        <span class="hl kwa">return</span> self<span class="hl opt">.</span>_db

    <span class="hl kwa">def</span> <span class="hl kwd">connect</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Connect to database. Missing error handling &quot;&quot;&quot;</span>
        logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;Opening database connection&quot;</span><span class="hl opt">)</span>

        <span class="hl kwa">return</span> MySQLdb<span class="hl opt">.</span><span class="hl kwd">connect</span><span class="hl opt">(</span>passwd<span class="hl opt">=</span>self<span class="hl opt">.</span>password<span class="hl opt">,</span> 
                               db<span class="hl opt">=</span>self<span class="hl opt">.</span>database<span class="hl opt">,</span>
                               user<span class="hl opt">=</span>self<span class="hl opt">.</span>username<span class="hl opt">)</span>

    <span class="hl kwa">def</span> <span class="hl kwd">send_data</span><span class="hl opt">(</span>self<span class="hl opt">,</span> name<span class="hl opt">,</span> data<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Saves data to name.data.json and sends it to </span>
<span class="hl str">            rt_settings.UPLOAD_URL &quot;&quot;&quot;</span>
        filename <span class="hl opt">=</span> name<span class="hl opt">+</span><span class="hl str">&quot;.data.json&quot;</span>
        logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;send_data with key&quot;</span><span class="hl opt">,</span> name<span class="hl opt">,</span> <span class="hl str">&quot;filename&quot;</span><span class="hl opt">,</span> filename<span class="hl opt">)</span>
        data_dump <span class="hl opt">=</span> json<span class="hl opt">.</span><span class="hl kwd">dumps</span><span class="hl opt">({</span><span class="hl str">&quot;name&quot;</span><span class="hl opt">:</span> name<span class="hl opt">,</span> <span class="hl str">&quot;data&quot;</span><span class="hl opt">:</span> data<span class="hl opt">})</span>
        <span class="hl kwb">open</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">).</span><span class="hl kwd">write</span><span class="hl opt">(</span>data_dump<span class="hl opt">)</span>
        datagen<span class="hl opt">,</span> headers <span class="hl opt">=</span> <span class="hl kwd">multipart_encode</span><span class="hl opt">({</span><span class="hl str">&quot;data&quot;</span><span class="hl opt">:</span> <span class="hl kwb">open</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> <span class="hl str">&quot;rb&quot;</span><span class="hl opt">),</span> <span class="hl str">&quot;password&quot;</span><span class="hl opt">:</span> self<span class="hl opt">.</span>upload_password<span class="hl opt">,</span> <span class="hl str">&quot;what&quot;</span><span class="hl opt">:</span> name<span class="hl opt">+</span><span class="hl str">&quot;.json&quot;</span><span class="hl opt">})</span>
        request <span class="hl opt">=</span> urllib2<span class="hl opt">.</span><span class="hl kwd">Request</span><span class="hl opt">(</span>self<span class="hl opt">.</span>upload_url<span class="hl opt">,</span> datagen<span class="hl opt">,</span> headers<span class="hl opt">)</span>
        urllib2<span class="hl opt">.</span><span class="hl kwd">urlopen</span><span class="hl opt">(</span>request<span class="hl opt">).</span><span class="hl kwd">read</span><span class="hl opt">()</span>

    <span class="hl kwa">def</span> <span class="hl kwd">run</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; get all statistics &quot;&quot;&quot;</span>
        self<span class="hl opt">.</span><span class="hl kwd">get_ticket_stats</span><span class="hl opt">()</span>

    <span class="hl kwa">def</span> <span class="hl kwd">get_ticket_stats</span><span class="hl opt">(</span>self<span class="hl opt">):</span>
        <span class="hl str">&quot;&quot;&quot; Get statistics for tickets &quot;&quot;&quot;</span>

        <span class="hl kwa">def</span> <span class="hl kwd">get_one</span><span class="hl opt">(</span>query<span class="hl opt">):</span>
            <span class="hl str">&quot;&quot;&quot; Execute query and return first column of first row &quot;&quot;&quot;</span>
            logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;get_one with query&quot;</span><span class="hl opt">,</span> query<span class="hl opt">)</span>
            cursor <span class="hl opt">=</span> self<span class="hl opt">.</span>db<span class="hl opt">.</span><span class="hl kwd">cursor</span><span class="hl opt">()</span>
            cursor<span class="hl opt">.</span><span class="hl kwd">execute</span><span class="hl opt">(</span>query<span class="hl opt">)</span>
            <span class="hl opt">(</span>count<span class="hl opt">,) =</span> cursor<span class="hl opt">.</span><span class="hl kwd">fetchone</span><span class="hl opt">()</span>
            <span class="hl kwa">return</span> count

        <span class="hl kwa">def</span> <span class="hl kwd">get_two_all</span><span class="hl opt">(</span>query<span class="hl opt">):</span>
            <span class="hl str">&quot;&quot;&quot; Execute query and return all rows as dictionary &quot;&quot;&quot;</span>
            logging<span class="hl opt">.</span><span class="hl kwd">debug</span><span class="hl opt">(</span><span class="hl str">&quot;get_two_all with query&quot;</span><span class="hl opt">,</span> query<span class="hl opt">)</span>
            cursor <span class="hl opt">=</span> self<span class="hl opt">.</span>db<span class="hl opt">.</span><span class="hl kwd">cursor</span><span class="hl opt">()</span>
            cursor<span class="hl opt">.</span><span class="hl kwd">execute</span><span class="hl opt">(</span>query<span class="hl opt">)</span>
            items <span class="hl opt">=</span> cursor<span class="hl opt">.</span><span class="hl kwd">fetchall</span><span class="hl opt">()</span>
            ret <span class="hl opt">= {}</span>
            <span class="hl kwa">for</span> name<span class="hl opt">,</span> count <span class="hl kwa">in</span> items<span class="hl opt">:</span>
                ret<span class="hl opt">[</span>name<span class="hl opt">] =</span> count
            
            <span class="hl kwa">return</span> ret
            

        data <span class="hl opt">= {}</span>
        <span class="hl slc"># total number of tickets, including automatic</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;all_tickets&quot;</span><span class="hl opt">] =</span> <span class="hl kwd">get_one</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(*) AS c FROM Tickets;&quot;</span><span class="hl opt">)</span>
        <span class="hl slc"># total number of tickets with unique subject</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;all_tickets_unique&quot;</span><span class="hl opt">] =</span> <span class="hl kwd">get_one</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(DISTINCT Subject) AS c FROM Tickets;&quot;</span><span class="hl opt">)</span>

        dates <span class="hl opt">= [</span><span class="hl str">&quot;Mon&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Tue&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Wed&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Thu&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Fri&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Sat&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Sun&quot;</span><span class="hl opt">]</span>
        xtitles <span class="hl opt">= [</span>a <span class="hl kwa">for</span> a <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">24</span><span class="hl opt">)]</span>

        data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">] = {}</span>

        <span class="hl kwa">for</span> item<span class="hl opt">,</span> query <span class="hl kwa">in</span> <span class="hl opt">[(</span><span class="hl str">&quot;all&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;SELECT DATE_FORMAT(Created, '%%H') AS timestamp, COUNT(*) AS c FROM Tickets WHERE DATE_FORMAT(Created, '%%a')='%s' GROUP BY timestamp;&quot;</span><span class="hl opt">),</span> 
                          <span class="hl opt">(</span><span class="hl str">&quot;manual&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;SELECT DATE_FORMAT(Created, '%%H') AS timestamp, COUNT(*) AS c FROM Tickets WHERE Queue=1 AND DATE_FORMAT(Created, '%%a')='%s' GROUP BY timestamp;&quot;</span><span class="hl opt">),</span> 
                    <span class="hl opt">(</span><span class="hl str">&quot;all_resolved&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;SELECT DATE_FORMAT(Resolved, '%%H') AS timestamp, COUNT(*) AS c FROM Tickets WHERE DATE_FORMAT(Resolved, '%%a')='%s' GROUP BY timestamp;&quot;</span><span class="hl opt">),</span>
                 <span class="hl opt">(</span><span class="hl str">&quot;manual_resolved&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;SELECT DATE_FORMAT(Resolved, '%%H') AS timestamp, COUNT(*) AS c FROM Tickets WHERE Queue=1 AND DATE_FORMAT(Resolved, '%%a')='%s' GROUP BY timestamp;&quot;</span><span class="hl opt">)]:</span>
            data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">] = {}</span>
            data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;ytitles&quot;</span><span class="hl opt">] =</span> dates
            data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;xtitles&quot;</span><span class="hl opt">] = []</span>

            <span class="hl kwa">for</span> hour <span class="hl kwa">in</span> xtitles<span class="hl opt">:</span>
                tmp3 <span class="hl opt">=</span> <span class="hl kwb">str</span><span class="hl opt">(</span>hour<span class="hl opt">).</span><span class="hl kwd">strip</span><span class="hl opt">()</span>
                <span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl opt">(</span>tmp3<span class="hl opt">) ==</span> <span class="hl num">1</span><span class="hl opt">:</span>
                    tmp3 <span class="hl opt">=</span> <span class="hl str">&quot;0&quot;</span><span class="hl opt">+</span>tmp3
                data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;xtitles&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">(</span>tmp3<span class="hl opt">)</span>
            data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;date_stats&quot;</span><span class="hl opt">] = []</span>

            <span class="hl kwa">for</span> day <span class="hl kwa">in</span> dates<span class="hl opt">:</span>
                tmp <span class="hl opt">=</span> <span class="hl kwd">get_two_all</span><span class="hl opt">(</span>query <span class="hl opt">%</span> day<span class="hl opt">)</span>
                <span class="hl kwa">for</span> xtitle <span class="hl kwa">in</span> xtitles<span class="hl opt">:</span>
                    tmp3 <span class="hl opt">=</span> <span class="hl kwb">str</span><span class="hl opt">(</span>xtitle<span class="hl opt">).</span><span class="hl kwd">strip</span><span class="hl opt">()</span>
                    <span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl opt">(</span>tmp3<span class="hl opt">) ==</span> <span class="hl num">1</span><span class="hl opt">:</span>
                        tmp3 <span class="hl opt">=</span> <span class="hl str">&quot;0&quot;</span><span class="hl opt">+</span>tmp3
                    data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;date_stats&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">(</span>tmp<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>tmp3<span class="hl opt">,</span> <span class="hl kwa">None</span><span class="hl opt">))</span>
            data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;date_stats&quot;</span><span class="hl opt">] =</span> data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;date_stats&quot;</span><span class="hl opt">][-</span><span class="hl num">3</span><span class="hl opt">:] +</span> data<span class="hl opt">[</span><span class="hl str">&quot;dots&quot;</span><span class="hl opt">][</span>item<span class="hl opt">][</span><span class="hl str">&quot;date_stats&quot;</span><span class="hl opt">][:-</span><span class="hl num">3</span><span class="hl opt">]</span>

        <span class="hl slc"># number of unique subjects</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;unique_manual&quot;</span><span class="hl opt">] =</span> <span class="hl kwd">get_one</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(distinct(Subject)) AS c FROM Tickets WHERE Queue=1;&quot;</span><span class="hl opt">)</span>
        <span class="hl kwa">for</span> daterange <span class="hl kwa">in</span> <span class="hl opt">[</span><span class="hl str">&quot;7&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;30&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;365&quot;</span><span class="hl opt">]:</span>
            data<span class="hl opt">[</span><span class="hl str">&quot;unique_manual_%sd&quot;</span> <span class="hl opt">%</span> daterange<span class="hl opt">] =</span> <span class="hl kwd">get_one</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(DISTINCT Subject) AS c FROM Tickets WHERE Created &gt;= DATE_SUB(current_date, INTERVAL %s day) AND Queue=1;&quot;</span> <span class="hl opt">%</span> daterange<span class="hl opt">)</span>

        dayranges <span class="hl opt">= [</span><span class="hl str">&quot;7&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;30&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;365&quot;</span><span class="hl opt">]</span>
        datenames <span class="hl opt">= [</span><span class="hl str">&quot;Created&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Resolved&quot;</span><span class="hl opt">]</span>
        variable_name <span class="hl opt">= [(</span><span class="hl str">&quot;hour&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;%H&quot;</span><span class="hl opt">), (</span><span class="hl str">&quot;day&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;%a&quot;</span><span class="hl opt">)]</span>
        <span class="hl kwa">for</span> datename <span class="hl kwa">in</span> datenames<span class="hl opt">:</span>
            <span class="hl kwa">for</span> <span class="hl opt">(</span>vbn<span class="hl opt">,</span> vbn_f<span class="hl opt">)</span> <span class="hl kwa">in</span> variable_name<span class="hl opt">:</span>
                data<span class="hl opt">[</span><span class="hl str">&quot;%s_per_%s&quot;</span> <span class="hl opt">% (</span>datename<span class="hl opt">.</span><span class="hl kwd">lower</span><span class="hl opt">(),</span> vbn<span class="hl opt">)] =</span> <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(%s, '%%%s') AS timestamp, COUNT(*) AS c FROM Tickets WHERE Queue=1 GROUP BY timestamp;&quot;</span> <span class="hl opt">% (</span>datename<span class="hl opt">,</span> vbn_f<span class="hl opt">))</span>
                <span class="hl kwa">for</span> dayrange <span class="hl kwa">in</span> dayranges<span class="hl opt">:</span>
                    data<span class="hl opt">[</span><span class="hl str">&quot;%s_per_%s_%sd&quot;</span> <span class="hl opt">% (</span>datename<span class="hl opt">.</span><span class="hl kwd">lower</span><span class="hl opt">(),</span> vbn<span class="hl opt">,</span> dayrange<span class="hl opt">)] =</span> <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(%s, '%%%s') AS timestamp, COUNT(*) AS c FROM Tickets WHERE Queue=1 AND %s &gt;= DATE_SUB(current_date, INTERVAL %s day) GROUP BY timestamp;&quot;</span> <span class="hl opt">% (</span>datename<span class="hl opt">,</span> vbn_f<span class="hl opt">,</span> datename<span class="hl opt">,</span> dayrange<span class="hl opt">))</span>

        <span class="hl slc"># general tickets per day</span>
        dictlist <span class="hl opt">= [(</span><span class="hl str">&quot;created_futu&quot;</span><span class="hl opt">,</span> 
            <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(Tickets.Created, '%j') AS timestamp, COUNT(*) AS c FROM Tickets, Users WHERE Tickets.Created &gt;= DATE_SUB(current_date, INTERVAL 120 day) AND Tickets.Creator=Users.id AND Users.EmailAddress like '%.%&#64;futurice.com' AND Users.EmailAddress not in ('phaser&#64;futurice.com', 'mailman&#64;futurice.com', 'noreply&#64;futurice.com', 'zabbix&#64;futurice.com') GROUP BY timestamp;&quot;</span><span class="hl opt">)</span>
         <span class="hl opt">), (</span><span class="hl str">&quot;created_other&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(Tickets.Created, '%j') AS timestamp, COUNT(*) AS c FROM Tickets, Users WHERE Tickets.Created &gt;= DATE_SUB(current_date, INTERVAL 120 day) AND Tickets.Creator=Users.id AND Users.EmailAddress not like '%&#64;%futurice.com' GROUP BY timestamp;&quot;</span><span class="hl opt">)</span>
         <span class="hl opt">), (</span><span class="hl str">&quot;created_machine&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(Tickets.Created, '%j') AS timestamp, COUNT(*) AS c FROM Tickets, Users WHERE Tickets.Created &gt;= DATE_SUB(current_date, INTERVAL 120 day) AND Tickets.Creator=Users.id AND (Users.EmailAddress like '%&#64;%.futurice.com' or Users.EmailAddress in ('zabbix&#64;futurice.com', 'mailman&#64;futurice.com', 'noreply&#64;futurice.com')) GROUP BY timestamp;&quot;</span><span class="hl opt">)</span>
         <span class="hl opt">), (</span><span class="hl str">&quot;resolved_futu&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(Tickets.Resolved, '%j') AS timestamp, COUNT(*) AS c FROM Tickets, Users WHERE Tickets.Resolved &gt;= DATE_SUB(current_date, INTERVAL 120 day) AND Tickets.Creator=Users.id AND Users.EmailAddress like '%.%&#64;futurice.com' AND Users.EmailAddress not in ('phaser&#64;futurice.com', 'mailman&#64;futurice.com', 'noreply&#64;futurice.com', 'zabbix&#64;futurice.com') GROUP BY timestamp;&quot;</span><span class="hl opt">)</span>
         <span class="hl opt">), (</span><span class="hl str">&quot;resolved_other&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(Tickets.Resolved, '%j') AS timestamp, COUNT(*) AS c FROM Tickets, Users WHERE Tickets.Resolved &gt;= DATE_SUB(current_date, INTERVAL 120 day) AND Tickets.Creator=Users.id AND Users.EmailAddress not like '%&#64;%futurice.com' GROUP BY timestamp;&quot;</span><span class="hl opt">)</span>
         <span class="hl opt">), (</span><span class="hl str">&quot;resolved_machine&quot;</span><span class="hl opt">,</span>
            <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT DATE_FORMAT(Tickets.Resolved, '%j') AS timestamp, COUNT(*) AS c FROM Tickets, Users WHERE Tickets.Resolved &gt;= DATE_SUB(current_date, INTERVAL 120 day) AND Tickets.Creator=Users.id AND (Users.EmailAddress like '%&#64;%.futurice.com' or Users.EmailAddress in ('zabbix&#64;futurice.com', 'mailman&#64;futurice.com', 'noreply&#64;futurice.com')) GROUP BY timestamp;&quot;</span><span class="hl opt">)</span>
        <span class="hl opt">)]</span>

        final_workflow <span class="hl opt">= {</span><span class="hl str">&quot;max&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;buckets&quot;</span><span class="hl opt">: [],</span> <span class="hl str">&quot;authors&quot;</span><span class="hl opt">: {</span>
            <span class="hl str">&quot;0&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;n&quot;</span><span class="hl opt">:</span> <span class="hl str">&quot;Created by employees&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;d&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span>
            <span class="hl str">&quot;1&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;n&quot;</span><span class="hl opt">:</span> <span class="hl str">&quot;Created by external&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;d&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span>
            <span class="hl str">&quot;2&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;n&quot;</span><span class="hl opt">:</span> <span class="hl str">&quot;Created by machine&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;d&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span>
            <span class="hl str">&quot;3&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;n&quot;</span><span class="hl opt">:</span> <span class="hl str">&quot;Employee ticket resolved&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;d&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span>
            <span class="hl str">&quot;4&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;n&quot;</span><span class="hl opt">:</span> <span class="hl str">&quot;External ticket resolved&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;d&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">},</span>
            <span class="hl str">&quot;5&quot;</span><span class="hl opt">: {</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;n&quot;</span><span class="hl opt">:</span> <span class="hl str">&quot;Machine ticket resolved&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;d&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;u&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">}</span>
        <span class="hl opt">}}</span>
        date_translations <span class="hl opt">= {}</span>
        current_date <span class="hl opt">=</span> <span class="hl kwb">int</span><span class="hl opt">(</span>datetime<span class="hl opt">.</span>date<span class="hl opt">.</span><span class="hl kwd">today</span><span class="hl opt">().</span><span class="hl kwd">strftime</span><span class="hl opt">(</span><span class="hl str">&quot;%j&quot;</span><span class="hl opt">))</span>
        date_translations<span class="hl opt">[</span>current_date<span class="hl opt">] =</span> <span class="hl num">0</span>
        count <span class="hl opt">=</span> <span class="hl num">0</span>
        counttemp <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">for</span> numbers <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span>current_date<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">):</span>
            counttemp <span class="hl opt">+=</span> <span class="hl num">1</span>
            <span class="hl kwa">if</span> counttemp <span class="hl opt">%</span> <span class="hl num">7</span> <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                count <span class="hl opt">=</span> count <span class="hl opt">-</span> <span class="hl num">1</span>
            date_translations<span class="hl opt">[</span>numbers<span class="hl opt">] =</span> count
        <span class="hl kwa">for</span> numbers <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">366</span><span class="hl opt">,</span> current_date<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">):</span>
            counttemp <span class="hl opt">+=</span> <span class="hl num">1</span>
            <span class="hl kwa">if</span> counttemp <span class="hl opt">%</span> <span class="hl num">7</span> <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">:</span>
                count <span class="hl opt">=</span> count <span class="hl opt">-</span> <span class="hl num">1</span>
            date_translations<span class="hl opt">[</span>numbers<span class="hl opt">] =</span> count

        list_temp <span class="hl opt">= {}</span>
        value_counters <span class="hl opt">= [</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">]</span>
        name_value_table <span class="hl opt">= {</span><span class="hl str">&quot;created_futu&quot;</span><span class="hl opt">:</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;created_other&quot;</span><span class="hl opt">:</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl str">&quot;created_machine&quot;</span><span class="hl opt">:</span> <span class="hl num">2</span><span class="hl opt">,</span> <span class="hl str">&quot;resolved_futu&quot;</span><span class="hl opt">:</span> <span class="hl num">3</span><span class="hl opt">,</span> <span class="hl str">&quot;resolved_other&quot;</span><span class="hl opt">:</span> <span class="hl num">4</span><span class="hl opt">,</span> <span class="hl str">&quot;resolved_machine&quot;</span><span class="hl opt">:</span> <span class="hl num">5</span><span class="hl opt">}</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span>name<span class="hl opt">,</span> items<span class="hl opt">)</span> <span class="hl kwa">in</span> dictlist<span class="hl opt">:</span>
            <span class="hl kwa">for</span> item <span class="hl kwa">in</span> items<span class="hl opt">:</span>
                itemnum <span class="hl opt">=</span> date_translations<span class="hl opt">[</span><span class="hl kwb">int</span><span class="hl opt">(</span>item<span class="hl opt">)]</span>
                <span class="hl kwa">if not</span> list_temp<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>itemnum<span class="hl opt">):</span>
                    list_temp<span class="hl opt">[</span>itemnum<span class="hl opt">] = {}</span>
                <span class="hl kwa">if not</span> list_temp<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>itemnum<span class="hl opt">).</span><span class="hl kwd">get</span><span class="hl opt">(</span>name<span class="hl opt">):</span>
                    list_temp<span class="hl opt">[</span>itemnum<span class="hl opt">][</span>name<span class="hl opt">] =</span> <span class="hl num">0</span>
                list_temp<span class="hl opt">[</span>itemnum<span class="hl opt">][</span>name<span class="hl opt">] +=</span> items<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>item<span class="hl opt">)</span>
                value_counters<span class="hl opt">[</span>name_value_table<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>name<span class="hl opt">)] +=</span> items<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>item<span class="hl opt">)</span>
        <span class="hl kwa">for</span> key <span class="hl kwa">in</span> <span class="hl kwb">sorted</span><span class="hl opt">(</span>list_temp<span class="hl opt">.</span><span class="hl kwd">iterkeys</span><span class="hl opt">()):</span>
            values_temp <span class="hl opt">=</span> list_temp<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>key<span class="hl opt">)</span>
            values <span class="hl opt">= []</span>
            <span class="hl kwa">for</span> item <span class="hl kwa">in</span> values_temp<span class="hl opt">:</span>
                <span class="hl kwa">if</span> values_temp<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>item<span class="hl opt">) &gt;</span> final_workflow<span class="hl opt">[</span><span class="hl str">&quot;max&quot;</span><span class="hl opt">]:</span>
                    final_workflow<span class="hl opt">[</span><span class="hl str">&quot;max&quot;</span><span class="hl opt">] =</span> values_temp<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>item<span class="hl opt">)</span>
                values<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">([</span>name_value_table<span class="hl opt">[</span>item<span class="hl opt">],</span> values_temp<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>item<span class="hl opt">)])</span>
            <span class="hl slc"># sort values from highest to lowest</span>
            values<span class="hl opt">.</span><span class="hl kwd">sort</span><span class="hl opt">(</span>key<span class="hl opt">=</span><span class="hl kwa">lambda</span> x<span class="hl opt">:</span> x<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">])</span>
            final_workflow<span class="hl opt">[</span><span class="hl str">&quot;buckets&quot;</span><span class="hl opt">].</span><span class="hl kwd">append</span><span class="hl opt">({</span><span class="hl str">&quot;d&quot;</span><span class="hl opt">:</span> <span class="hl kwb">int</span><span class="hl opt">(</span><span class="hl kwd">time</span><span class="hl opt">() +</span> <span class="hl num">7</span> <span class="hl opt">*</span> <span class="hl num">86400</span> <span class="hl opt">* (</span><span class="hl num">1</span> <span class="hl opt">+</span> key<span class="hl opt">)),</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">:</span> values<span class="hl opt">})</span>

        counter <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">for</span> item <span class="hl kwa">in</span> value_counters<span class="hl opt">:</span>
            final_workflow<span class="hl opt">[</span><span class="hl str">&quot;authors&quot;</span><span class="hl opt">][</span><span class="hl kwb">str</span><span class="hl opt">(</span>counter<span class="hl opt">)][</span><span class="hl str">&quot;c&quot;</span><span class="hl opt">] =</span> item
            counter <span class="hl opt">+=</span> <span class="hl num">1</span>

        <span class="hl slc"># distribution of subject occurance</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;subject_occurance&quot;</span><span class="hl opt">] =</span> <span class="hl kwd">get_two_all</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT c AS occurance, COUNT(*) AS count FROM (select COUNT(*) AS c FROM Tickets WHERE Queue=1 GROUP BY Subject) AS Subjects GROUP BY c;&quot;</span><span class="hl opt">)</span>

        data<span class="hl opt">[</span><span class="hl str">&quot;workflow&quot;</span><span class="hl opt">] =</span> final_workflow

        data<span class="hl opt">[</span><span class="hl str">&quot;open_tickets&quot;</span><span class="hl opt">] =</span> <span class="hl kwd">get_one</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(*) AS c FROM Tickets WHERE (status='open' AND (Queue=1 AND Type!='reminder'));&quot;</span><span class="hl opt">)</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;new_tickets&quot;</span><span class="hl opt">] =</span> <span class="hl kwd">get_one</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(*) AS c FROM Tickets WHERE (status='new' AND (Queue=1 AND Type!='reminder'));&quot;</span><span class="hl opt">)</span>

        cursor <span class="hl opt">=</span> self<span class="hl opt">.</span>db<span class="hl opt">.</span><span class="hl kwd">cursor</span><span class="hl opt">()</span>
        cursor<span class="hl opt">.</span><span class="hl kwd">execute</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(*) AS c FROM Users WHERE EmailAddress like '%.%&#64;futurice.com';&quot;</span><span class="hl opt">)</span>
        <span class="hl opt">(</span>futurice_users<span class="hl opt">, ) =</span> cursor<span class="hl opt">.</span><span class="hl kwd">fetchone</span><span class="hl opt">()</span>
        cursor<span class="hl opt">.</span><span class="hl kwd">execute</span><span class="hl opt">(</span><span class="hl str">&quot;SELECT COUNT(*) AS c FROM Users WHERE EmailAddress not like '%.%&#64;futurice.com';&quot;</span><span class="hl opt">)</span>
        <span class="hl opt">(</span>other_users<span class="hl opt">, ) =</span> cursor<span class="hl opt">.</span><span class="hl kwd">fetchone</span><span class="hl opt">()</span>
        data<span class="hl opt">[</span><span class="hl str">&quot;other_users&quot;</span><span class="hl opt">] =</span> other_users
        data<span class="hl opt">[</span><span class="hl str">&quot;futurice_users&quot;</span><span class="hl opt">] =</span> futurice_users
        cursor<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">()</span>
        self<span class="hl opt">.</span><span class="hl kwd">send_data</span><span class="hl opt">(</span><span class="hl str">&quot;ittickets&quot;</span><span class="hl opt">,</span> data<span class="hl opt">)</span>


<span class="hl kwa">def</span> <span class="hl kwd">main</span><span class="hl opt">():</span>
    <span class="hl str">&quot;&quot;&quot; Run and save &quot;&quot;&quot;</span>
    rtstats <span class="hl opt">=</span> <span class="hl kwd">RTStats</span><span class="hl opt">()</span>
    rtstats<span class="hl opt">.</span><span class="hl kwd">run</span><span class="hl opt">()</span>

<span class="hl kwa">if</span> __name__ <span class="hl opt">==</span> <span class="hl str">'__main__'</span><span class="hl opt">:</span>
    <span class="hl kwd">main</span><span class="hl opt">()</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.5, http://www.andre-simon.de/-->
